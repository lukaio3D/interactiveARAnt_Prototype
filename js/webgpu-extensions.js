"use strict";(self.webpackChunkbabylonjs_typescript_webpack_template=self.webpackChunkbabylonjs_typescript_webpack_template||[]).push([[402],{8184:(e,t,r)=>{var n=r(7782),s=r(4836);r(7207),s.$.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode===e&&(0===e&&!this._alphaState.alphaBlend||0!==e&&this._alphaState.alphaBlend)){if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}}else{switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0}t||(this.setDepthWrite(0===e),this._cacheRenderPipeline.setDepthWriteEnabled(0===e)),this._alphaMode=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}},s.$.prototype.setAlphaEquation=function(e){n.$.prototype.setAlphaEquation.call(this,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};var i=r(461),a=r(6230);class o{getBindGroups(e,t,r){if(!r)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){const n=this._bindGroupEntries.length>0;for(const t in e){const s=e[t],a=r[t],o=a.group,u=a.binding,c=s.type,l=s.object;let h=s.indexInGroupEntries,p=this._bindGroupEntries[o];switch(p||(p=this._bindGroupEntries[o]=[]),c){case 5:{const e=l;void 0!==h&&n?p[h].resource=this._cacheSampler.getSampler(e):(s.indexInGroupEntries=p.length,p.push({binding:u,resource:this._cacheSampler.getSampler(e)}));break}case 0:case 4:{const e=l,t=e._texture._hardwareTexture;void 0!==h&&n?(0===c&&(p[h++].resource=this._cacheSampler.getSampler(e._texture)),p[h].resource=t.view):(s.indexInGroupEntries=p.length,0===c&&p.push({binding:u-1,resource:this._cacheSampler.getSampler(e._texture)}),p.push({binding:u,resource:t.view}));break}case 1:{const e=l,t=e._texture._hardwareTexture;8&t.textureAdditionalUsages||i.V.Error(`computeDispatch: The texture (name=${e.name}, uniqueId=${e.uniqueId}) is not a storage texture!`,50),void 0!==h&&n?p[h].resource=t.viewForWriting:(s.indexInGroupEntries=p.length,p.push({binding:u,resource:t.viewForWriting}));break}case 6:{const e=l.underlyingResource;void 0!==h&&n?p[h].resource=this._device.importExternalTexture({source:e}):(s.indexInGroupEntries=p.length,p.push({binding:u,resource:this._device.importExternalTexture({source:e})}));break}case 2:case 3:case 7:{const e=7===c?l:l.getBuffer(),t=e.underlyingResource;void 0!==h&&n?(p[h].resource.buffer=t,p[h].resource.size=e.capacity):(s.indexInGroupEntries=p.length,p.push({binding:u,resource:{buffer:t,offset:0,size:e.capacity}}));break}}}for(let e=0;e<this._bindGroupEntries.length;++e){const r=this._bindGroupEntries[e];this._bindGroups[e]=r?this._device.createBindGroup({layout:t.getBindGroupLayout(e),entries:r}):void 0}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=o._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}o._Counter=0;class u{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){return this.sources?.compute}dispose(){}}const c={};s.$.prototype.createComputeContext=function(){return new o(this._device,this._cacheSampler)},s.$.prototype.createComputeEffect=function(e,t){const r=("string"==typeof e?e:e.computeToken||e.computeSource||e.computeElement||e.compute)+"@"+t.defines;if(this._compiledComputeEffects[r]){const e=this._compiledComputeEffects[r];return t.onCompiled&&e.isReady()&&t.onCompiled(e),e}const n=new a.B(e,t,this,r);return this._compiledComputeEffects[r]=n,n},s.$.prototype.createComputePipelineContext=function(){return new u(this)},s.$.prototype.areAllComputeEffectsReady=function(){for(const e in this._compiledComputeEffects)if(!this._compiledComputeEffects[e].isReady())return!1;return!0},s.$.prototype.computeDispatch=function(e,t,r,n,s=1,i=1,a,o){this._computeDispatch(e,t,r,n,s,i,void 0,void 0,a,o)},s.$.prototype.computeDispatchIndirect=function(e,t,r,n,s=0,i,a){this._computeDispatch(e,t,r,void 0,void 0,void 0,n,s,i,a)},s.$.prototype._computeDispatch=function(e,t,r,n,s,i,a,o,u,l){this._endCurrentRenderPass();const h=e._pipelineContext,p=t;h.computePipeline||(h.computePipeline=this._device.createComputePipeline({layout:"auto",compute:h.stage})),l&&this._timestampQuery.startPass(c,this._timestampIndex);const d=this._renderEncoder.beginComputePass(c);d.setPipeline(h.computePipeline);const g=p.getBindGroups(r,h.computePipeline,u);for(let e=0;e<g.length;++e){const t=g[e];t&&d.setBindGroup(e,t)}void 0!==a?d.dispatchWorkgroupsIndirect(a.underlyingResource,o):n+s+i>0&&d.dispatchWorkgroups(n,s,i),d.end(),l&&(this._timestampQuery.endPass(this._timestampIndex,l),this._timestampIndex+=2)},s.$.prototype.releaseComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e].getPipelineContext();this._deleteComputePipelineContext(t)}this._compiledComputeEffects={}},s.$.prototype._prepareComputePipelineContext=function(e,t,r,n,s){const a=e;this.dbgShowShaderCode&&(i.V.Log(n),i.V.Log(t)),a.sources={compute:t,rawCompute:r},a.stage=this._createComputePipelineStageDescriptor(t,n,s)},s.$.prototype._releaseComputeEffect=function(e){this._compiledComputeEffects[e._key]&&(delete this._compiledComputeEffects[e._key],this._deleteComputePipelineContext(e.getPipelineContext()))},s.$.prototype._rebuildComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}},s.$.prototype._executeWhenComputeStateIsCompiled=function(e,t){e.stage.module.getCompilationInfo().then((e=>{const r={numErrors:0,messages:[]};for(const t of e.messages)"error"===t.type&&r.numErrors++,r.messages.push({type:t.type,text:t.message,line:t.lineNum,column:t.linePos,length:t.length,offset:t.offset});t(r)}))},s.$.prototype._deleteComputePipelineContext=function(e){e&&e.dispose()},s.$.prototype._createComputePipelineStageDescriptor=function(e,t,r){return t=t?"//"+t.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:t+e}),entryPoint:r}};var l=r(7565),h=r(9738);s.$.prototype._createDepthStencilCubeTexture=function(e,t){const r=new l.h(this,t.generateStencil?12:14);r.isCube=!0,r.label=t.label;const n={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t};r.format=n.depthTextureFormat,this._setupDepthStencilTexture(r,e,n.generateStencil,n.bilinearFiltering,n.comparisonFunction,n.samples),this._textureHelper.createGPUTextureForInternalTexture(r);const s=r._hardwareTexture;return r.type=h.m.GetTextureTypeFromFormat(s.format),this._internalTexturesCache.push(r),r},s.$.prototype.createCubeTexture=function(e,t,r,n,s=null,i=null,a,o=null,u=!1,c=0,l=0,h=null,p,d=!1,g=null){return this.createCubeTextureBase(e,t,r,!!n,s,i,a,o,u,c,l,h,null,((e,t)=>{const r=t,i=r[0].width,o=i;this._setCubeMapTextureParams(e,!n),e.format=a??-1;const u=this._textureHelper.createGPUTextureForInternalTexture(e,i,o);this._textureHelper.updateCubeTextures(r,u.underlyingResource,i,o,u.format,!1,!1,0,0),n||this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),s&&s()}),!!d,g)},s.$.prototype._setCubeMapTextureParams=function(e,t,r){e.samplingMode=t?3:2,e._cachedWrapU=0,e._cachedWrapV=0,r&&(e._maxLodLevel=r)},s.$.prototype.generateMipMapsForCubemap=function(e){if(e.generateMipMaps){const t=e._hardwareTexture?.underlyingResource;t||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e)}},s.$.prototype._debugPushGroup=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?this._renderEncoder.pushDebugGroup(e):this._currentRenderPass?this._currentRenderPass.pushDebugGroup(e):this._pendingDebugCommands.push(["push",e]))},s.$.prototype._debugPopGroup=function(e){this._options.enableGPUDebugMarkers&&(0===e||1===e?this._renderEncoder.popDebugGroup():this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null]))},s.$.prototype._debugInsertMarker=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?this._renderEncoder.insertDebugMarker(e):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e]))},s.$.prototype._debugFlushPendingCommands=function(){for(let e=0;e<this._pendingDebugCommands.length;++e){const[t,r]=this._pendingDebugCommands[e];switch(t){case"push":this._debugPushGroup(r);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(r)}}this._pendingDebugCommands.length=0};var p=r(1585);s.$.prototype.createDynamicTexture=function(e,t,r,n){const s=new l.h(this,4);return s.baseWidth=e,s.baseHeight=t,r&&(e=this.needPOTTextures?(0,p.R)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,p.R)(t,this._caps.maxTextureSize):t),s.width=e,s.height=t,s.isReady=!1,s.generateMipMaps=r,s.samplingMode=n,this.updateTextureSamplingMode(n,s),this._internalTexturesCache.push(s),e&&t&&this._textureHelper.createGPUTextureForInternalTexture(s,e,t),s},s.$.prototype.updateDynamicTexture=function(e,t,r,n=!1,s,i,a){if(!e)return;const o=t.width,u=t.height;let c=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(e,o,u)),this._textureHelper.updateTexture(t,e,o,u,e.depth,c.format,0,0,r,n,0,0,a),e.generateMipMaps&&this._generateMipmaps(e),e._dynamicTextureSource=t,e._premulAlpha=n,e.invertY=r||!1,e.isReady=!0},s.$.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,r){r&&r();const n=e._attachments.length;this._endCurrentRenderPass();for(let r=0;r<n;r++){const n=e.textures[r];!n.generateMipMaps||t||n.isCube||n.is3D||this._generateMipmaps(n)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)},s.$.prototype.createMultipleRenderTarget=function(e,t,r){let n=!1,s=!0,a=!1,o=!1,u=15,c=1,h=[],p=[],d=[],g=[],m=[],f=[],_=[],b=[],x=[];const y=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(n=void 0!==t.generateMipMaps&&t.generateMipMaps,s=void 0===t.generateDepthBuffer||t.generateDepthBuffer,a=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,o=void 0!==t.generateDepthTexture&&t.generateDepthTexture,c=t.textureCount||1,u=t.depthTextureFormat??15,t.types&&(h=t.types),t.samplingModes&&(p=t.samplingModes),t.useSRGBBuffers&&(d=t.useSRGBBuffers),t.formats&&(g=t.formats),t.targetTypes&&(m=t.targetTypes),t.faceIndex&&(f=t.faceIndex),t.layerIndex&&(_=t.layerIndex),t.layerCounts&&(b=t.layerCounts),x=t.labels??x),y.label=t?.label??"MultiRenderTargetWrapper";const S=e.width||e,v=e.height||e;let I=null;(s||a||o)&&(o||(u=s&&a?13:s?14:19),I=y.createDepthStencilTexture(0,!1,a,1,u,"MultipleRenderTargetDepthStencil"));const B=[],w=[],T=[];y._generateDepthBuffer=s,y._generateStencilBuffer=a,y._attachments=w,y._defaultAttachments=T;for(let e=0;e<c;e++){let t=p[e]||3,s=h[e]||0;const a=g[e]||5,o=!!d[e]&&this._caps.supportSRGBBuffers,u=m[e]||3553,c=b[e]??1;if((1!==s||this._caps.textureFloatLinearFiltering)&&(2!==s||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==s||this._caps.textureFloat||(s=0,i.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),w.push(e+1),T.push(r?e+1:0===e?1:0),-1===u)continue;const f=new l.h(this,6);switch(B[e]=f,u){case 34067:f.isCube=!0;break;case 32879:f.is3D=!0,f.baseDepth=f.depth=c;break;case 35866:f.is2DArray=!0,f.baseDepth=f.depth=c}f.baseWidth=S,f.baseHeight=v,f.width=S,f.height=v,f.isReady=!0,f.samples=1,f.generateMipMaps=n,f.samplingMode=t,f.type=s,f._cachedWrapU=0,f._cachedWrapV=0,f._useSRGBBuffer=o,f.format=a,f.label=x[e],this._internalTexturesCache.push(f),this._textureHelper.createGPUTextureForInternalTexture(f)}return I&&(I.incrementReferences(),B[c]=I,this._internalTexturesCache.push(I)),y.setTextures(B),y.setLayerAndFaceIndices(_,f),y},s.$.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||e.textures[0].samples===t)return t;const r=e.textures.length;if(0===r)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let t=0;t<r;++t){const r=e.textures[t]._hardwareTexture;r?.releaseMSAATexture()}const n=e._depthStencilTexture===e.textures[r-1];for(let s=0;s<r;++s){const i=e.textures[s];this._textureHelper.createMSAATexture(i,t,!1,s===r-1&&n?0:s),i.samples=t}return e._depthStencilTexture&&!n&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),t},s.$.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e))},s.$.prototype.buildTextureLayout=function(e){const t=[];for(let r=0;r<e.length;r++)e[r]?t.push(r+1):t.push(0);return t},s.$.prototype.restoreSingleAttachment=function(){},s.$.prototype.restoreSingleAttachmentForRenderTarget=function(){};var d=r(189);function g(e,t,r,n){let s,i=1;1===n?s=new Float32Array(t*r*4):2===n?(s=new Uint16Array(t*r*4),i=15360):s=7===n?new Uint32Array(t*r*4):new Uint8Array(t*r*4);for(let n=0;n<t;n++)for(let a=0;a<r;a++){const r=3*(a*t+n),o=4*(a*t+n);s[o+0]=e[r+0],s[o+1]=e[r+1],s[o+2]=e[r+2],s[o+3]=i}return s}r(6679),s.$.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},s.$.prototype.captureGPUFrameTime=function(e){this._timestampQuery.enable=e&&!!this._caps.timerQuery},s.$.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},s.$.prototype.deleteQuery=function(e){return this._occlusionQuery.deleteQuery(e),this},s.$.prototype.isQueryResultAvailable=function(e){return this._occlusionQuery.isQueryResultAvailable(e)},s.$.prototype.getQueryResult=function(e){return this._occlusionQuery.getQueryResult(e)},s.$.prototype.beginOcclusionQuery=function(e,t){return this.compatibilityMode?!!this._occlusionQuery.canBeginQuery(t)&&(this._currentRenderPass?.beginOcclusionQuery(t),!0):(this._bundleList.addItem(new d.KS(t)),!0)},s.$.prototype.endOcclusionQuery=function(){return this.compatibilityMode?this._currentRenderPass?.endOcclusionQuery():this._bundleList.addItem(new d.c7),this},s.$.prototype.createRawTexture=function(e,t,r,n,s,i,a,o=null,u=0,c=0,h=!1){const p=new l.h(this,3);return p.baseWidth=t,p.baseHeight=r,p.width=t,p.height=r,p.format=n,p.generateMipMaps=s,p.samplingMode=a,p.invertY=i,p._compression=o,p.type=u,p._creationFlags=c,p._useSRGBBuffer=h,this._doNotHandleContextLost||(p._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(p,t,r,void 0,c),this.updateRawTexture(p,e,n,i,o,u,h),this._internalTexturesCache.push(p),p},s.$.prototype.updateRawTexture=function(e,t,r,n,s=null,i=0,a=!1){if(e){if(this._doNotHandleContextLost||(e._bufferView=t,e.invertY=n,e._compression=s,e._useSRGBBuffer=a),t){const s=e._hardwareTexture;4===r&&(t=g(t,e.width,e.height,i));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,n,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},s.$.prototype.createRawCubeTexture=function(e,t,r,n,s,a,o,u=null){const c=new l.h(this,8);return 1!==n||this._caps.textureFloatLinearFiltering?2!==n||this._caps.textureHalfFloatLinearFiltering?1!==n||this._caps.textureFloatRender?2!==n||this._caps.colorBufferFloat||(s=!1,i.V.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(s=!1,i.V.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(s=!1,o=1,i.V.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(s=!1,o=1,i.V.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),c.isCube=!0,c._originalFormat=r,c.format=4===r?5:r,c.type=n,c.generateMipMaps=s,c.width=t,c.height=t,c.samplingMode=o,this._doNotHandleContextLost||(c._bufferViewArray=e),c.invertY=a,c._compression=u,c._cachedWrapU=0,c._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(c),4===r&&(c._hardwareTexture._originalFormatIsRGB=!0),e&&this.updateRawCubeTexture(c,e,r,n,a,u),c.isReady=!0,c},s.$.prototype.updateRawCubeTexture=function(e,t,r,n,s,i=null){e._bufferViewArray=t,e.invertY=s,e._compression=i;const a=e._hardwareTexture,o=a._originalFormatIsRGB,u=[0,2,4,1,3,5],c=[];for(let r=0;r<t.length;++r){let s=t[u[r]];o&&(s=g(s,e.width,e.height,n)),c.push(new Uint8Array(s.buffer,s.byteOffset,s.byteLength))}this._textureHelper.updateCubeTextures(c,a.underlyingResource,e.width,e.height,a.format,s,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0},s.$.prototype.createRawCubeTextureFromUrl=function(e,t,r,n,s,i,a,o,u=null,c=null,l=3,h=!1){const p=this.createRawCubeTexture(null,r,n,s,!i,h,l,null);t?.addPendingData(p),p.url=e,p.isReady=!1,this._internalTexturesCache.push(p);const d=e=>{const r=p.width,i=a(e);if(i){if(o){const e=4===n,t=o(i),a=p._hardwareTexture,u=[0,1,2,3,4,5];for(let n=0;n<t.length;n++){const i=r>>n,o=[];for(let r=0;r<6;r++){let a=t[n][u[r]];e&&(a=g(a,i,i,s)),o.push(new Uint8Array(a.buffer,a.byteOffset,a.byteLength))}this._textureHelper.updateCubeTextures(o,a.underlyingResource,i,i,a.format,h,!1,0,0)}}else this.updateRawCubeTexture(p,i,n,s,h);p.isReady=!0,t?.removePendingData(p),u&&u()}};return this._loadFile(e,(e=>{d(e)}),void 0,t?.offlineProvider,!0,((e,r)=>{t?.removePendingData(p),c&&e&&c(e.status+" "+e.statusText,r)})),p},s.$.prototype.createRawTexture3D=function(e,t,r,n,s,i,a,o,u=null,c=0,h=0){const p=new l.h(this,10);return p.baseWidth=t,p.baseHeight=r,p.baseDepth=n,p.width=t,p.height=r,p.depth=n,p.format=s,p.type=c,p.generateMipMaps=i,p.samplingMode=o,p.is3D=!0,p._creationFlags=h,this._doNotHandleContextLost||(p._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(p,t,r,void 0,h),this.updateRawTexture3D(p,e,s,a,u,c),this._internalTexturesCache.push(p),p},s.$.prototype.updateRawTexture3D=function(e,t,r,n,s=null,i=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.invertY=n,e._compression=s),t){const s=e._hardwareTexture;4===r&&(t=g(t,e.width,e.height,i));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,n,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},s.$.prototype.createRawTexture2DArray=function(e,t,r,n,s,i,a,o,u=null,c=0,h=0){const p=new l.h(this,11);return p.baseWidth=t,p.baseHeight=r,p.baseDepth=n,p.width=t,p.height=r,p.depth=n,p.format=s,p.type=c,p.generateMipMaps=i,p.samplingMode=o,p.is2DArray=!0,p._creationFlags=h,this._doNotHandleContextLost||(p._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(p,t,r,n,h),this.updateRawTexture2DArray(p,e,s,a,u,c),this._internalTexturesCache.push(p),p},s.$.prototype.updateRawTexture2DArray=function(e,t,r,n,s=null,i=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.invertY=n,e._compression=s),t){const s=e._hardwareTexture;4===r&&(t=g(t,e.width,e.height,i));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,n,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},s.$.prototype._readTexturePixels=function(e,t,r,n=-1,s=0,i=null,a=!0,o=!1,u=0,c=0){const l=e._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(l.underlyingResource,u,c,t,r,l.format,n,s,i,o)},s.$.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};var m=r(5892),f=r(6228);class _ extends m.v{constructor(e,t,r,n,s){super(e,t,r,n,s),n.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new f.e)}}r(3948),s.$.prototype._createHardwareRenderTargetWrapper=function(e,t,r){const n=new _(e,t,r,this);return this._renderTargetWrapperCache.push(n),n},s.$.prototype.createRenderTargetTexture=function(e,t){const r=this._createHardwareRenderTargetWrapper(!1,!1,e),n={};void 0!==t&&"object"==typeof t?(n.generateMipMaps=t.generateMipMaps,n.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,n.generateStencilBuffer=n.generateDepthBuffer&&t.generateStencilBuffer,n.samplingMode=void 0===t.samplingMode?3:t.samplingMode,n.creationFlags=t.creationFlags??0,n.noColorAttachment=!!t.noColorAttachment,n.samples=t.samples,n.label=t.label):(n.generateMipMaps=t,n.generateDepthBuffer=!0,n.generateStencilBuffer=!1,n.samplingMode=3,n.creationFlags=0,n.noColorAttachment=!1);const s=n.noColorAttachment?null:this._createInternalTexture(e,t,!0,5);return r.label=n.label??"RenderTargetWrapper",r._samples=n.samples??1,r._generateDepthBuffer=n.generateDepthBuffer,r._generateStencilBuffer=!!n.generateStencilBuffer,r.setTextures(s),(r._generateDepthBuffer||r._generateStencilBuffer)&&r.createDepthStencilTexture(0,!1,r._generateStencilBuffer,r.samples,n.generateStencilBuffer?13:14,n.label?n.label+"-DepthStencil":void 0),s&&(void 0!==t&&"object"==typeof t&&t.createMipMaps&&!n.generateMipMaps&&(s.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(s,void 0,void 0,void 0,n.creationFlags),void 0!==t&&"object"==typeof t&&t.createMipMaps&&!n.generateMipMaps&&(s.generateMipMaps=!1)),r},s.$.prototype._createDepthStencilTexture=function(e,t){const r=new l.h(this,t.generateStencil?12:14);r.label=t.label;const n={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t};r.format=n.depthTextureFormat,this._setupDepthStencilTexture(r,e,n.generateStencil,n.bilinearFiltering,n.comparisonFunction,n.samples),this._textureHelper.createGPUTextureForInternalTexture(r);const s=r._hardwareTexture;return r.type=h.m.GetTextureTypeFromFormat(s.format),this._internalTexturesCache.push(r),r},s.$.prototype._setupDepthStencilTexture=function(e,t,r,n,s,i=1){const a=t.width||t,o=t.height||t,u=t.layers||0,c=t.depth||0;e.baseWidth=a,e.baseHeight=o,e.width=a,e.height=o,e.is2DArray=u>0,e.is3D=c>0,e.depth=u||c,e.isReady=!0,e.samples=i,e.generateMipMaps=!1,e.samplingMode=n?2:1,e.type=1,e._comparisonFunction=s,e._cachedWrapU=0,e._cachedWrapV=0},s.$.prototype.updateRenderTargetTextureSampleCount=function(e,t){return e&&e.texture&&e.samples!==t?(t=Math.min(t,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(e.texture,t),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,e.texture.samples=t,t):t},s.$.prototype.createRenderTargetCubeTexture=function(e,t){const r=this._createHardwareRenderTargetWrapper(!1,!0,e),n={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...t};n.generateStencilBuffer=n.generateDepthBuffer&&n.generateStencilBuffer,r.label=n.label??"RenderTargetWrapper",r._generateDepthBuffer=n.generateDepthBuffer,r._generateStencilBuffer=n.generateStencilBuffer;const s=new l.h(this,5);return s.width=e,s.height=e,s.depth=0,s.isReady=!0,s.isCube=!0,s.samples=n.samples,s.generateMipMaps=n.generateMipMaps,s.samplingMode=n.samplingMode,s.type=n.type,s.format=n.format,this._internalTexturesCache.push(s),r.setTextures(s),(r._generateDepthBuffer||r._generateStencilBuffer)&&r.createDepthStencilTexture(0,void 0===n.samplingMode||2===n.samplingMode||2===n.samplingMode||3===n.samplingMode||3===n.samplingMode||5===n.samplingMode||6===n.samplingMode||7===n.samplingMode||11===n.samplingMode,r._generateStencilBuffer,r.samples),t&&t.createMipMaps&&!n.generateMipMaps&&(s.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(s),t&&t.createMipMaps&&!n.generateMipMaps&&(s.generateMipMaps=!1),r},s.$.prototype.setDepthStencilTexture=function(e,t,r,n){r&&r.depthStencilTexture?this._setTexture(e,r,!1,!0,n):this._setTexture(e,null,void 0,void 0,n)},s.$.prototype.updateVideoTexture=function(e,t,r){if(!e||e._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let n=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),function(e){return!(!e||void 0===e.underlyingResource)}(t)){if(t.isReady()){try{this._textureHelper.copyVideoToTexture(t,e,n.format,!r),e.generateMipMaps&&this._generateMipmaps(e)}catch(e){}e.isReady=!0}}else t&&this.createImageBitmap(t).then((t=>{this._textureHelper.updateTexture(t,e,e.width,e.height,e.depth,n.format,0,0,!r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0})).catch((()=>{e.isReady=!0}))}},3424:(e,t,r)=>{r.d(t,{u:()=>u});var n=r(5812);class s extends n.n{constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,this._buffer=e}get underlyingResource(){return this._buffer}}var i=r(6626),a=r(136),o=r(2455);class u{static _IsGPUBuffer(e){return void 0===e.underlyingResource}static _FlagsToString(e,t=""){let r=t;for(let t=0;t<=9;++t)e&1<<t&&(r&&(r+="_"),r+=o.Sd[1<<t]);return r}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,r=!1,n){const s=void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,i={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+u._FlagsToString(t,n??"Buffer")+"_size"+s,mappedAtCreation:r,size:s,usage:t};return this._device.createBuffer(i)}createBuffer(e,t,r){const n=void 0!==e.byteLength,i=this.createRawBuffer(e,t,void 0,r),a=new s(i);return a.references=1,a.capacity=n?e.byteLength:e,a.engineId=this._engine.uniqueId,n&&this.setSubData(a,0,e),a}setRawData(e,t,r,n,s){this._device.queue.writeBuffer(e,t,r.buffer,n,s)}setSubData(e,t,r,n=0,s=0){const i=e.underlyingResource;s=s||r.byteLength,s=Math.min(s,e.capacity-t);let a=r.byteOffset+n,o=a+s;const u=s+3&-4;if(u!==s){const e=new Uint8Array(r.buffer.slice(a,o));(r=new Uint8Array(u)).set(e),n=0,a=0,o=u,s=u}const c=15728640;let l=0;for(;o-(a+l)>c;)this._device.queue.writeBuffer(i,t+l,r.buffer,a+l,c),l+=c;this._device.queue.writeBuffer(i,t+l,r.buffer,a+l,s-l)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,r){r||(r=new Float32Array(e));const n=new Uint16Array(t);for(;e--;)r[e]=(0,i.SX)(n[e]);return r}readDataFromBuffer(e,t,r,n,s,i,o=0,u=0,c=null,l=!0,h=!1){const p=1===o?2:2===o?1:0,d=this._engine.uniqueId;return new Promise(((r,g)=>{e.mapAsync(1,u,t).then((()=>{const d=e.getMappedRange(u,t);let g=c;if(h)g=null===g?(0,a.k)(o,t,!0,d):(0,a.k)(o,g.buffer,void 0,d);else if(null===g)switch(p){case 0:g=new Uint8Array(t),g.set(new Uint8Array(d));break;case 1:g=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,d);break;case 2:g=new Float32Array(t/4),g.set(new Float32Array(d))}else switch(p){case 0:g=new Uint8Array(g.buffer),g.set(new Uint8Array(d));break;case 1:g=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,d,c);break;case 2:g=new Float32Array(g.buffer),g.set(new Float32Array(d))}if(s!==i){1!==p||h||(s*=2,i*=2);const e=new Uint8Array(g.buffer);let t=s,r=0;for(let a=1;a<n;++a){r=a*i;for(let n=0;n<s;++n)e[t++]=e[r++]}g=0===p||h?new Uint8Array(e.buffer,0,t):new Float32Array(e.buffer,0,t/4)}e.unmap(),l&&this.releaseBuffer(e),r(g)}),(e=>{this._engine.isDisposed||this._engine.uniqueId!==d?r(new Uint8Array):g(e)}))}))}releaseBuffer(e){return u._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),!0))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}},189:(e,t,r)=>{r.d(t,{Eb:()=>s,KS:()=>u,c7:()=>c,d_:()=>h,h1:()=>a,qY:()=>o,w$:()=>i});var n=r(9738);class s{constructor(e,t,r,n){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(r),this.h=Math.floor(n)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new s(this.x,this.y,this.w,this.h)}}class i{constructor(e,t,r,n){this.x=e,this.y=t,this.w=r,this.h=n}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new i(this.x,this.y,this.w,this.h)}}class a{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new a(this.ref)}}class o{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new o(this.color)}}class u{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new u(this.query)}}class c{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new c}}class l{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new l;return e.bundles=this.bundles,e}}class h{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const e=new l;this._list[this._listLength++]=e,this._currentBundleList=e.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,r){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:n.m.GetSample(r)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new h(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}},4960:(e,t,r)=>{r.d(t,{k:()=>i});var n=r(461);class s{constructor(){this.values={}}}class i{static get Statistics(){return{totalCreated:i.NumBindGroupsCreatedTotal,lastFrameCreated:i.NumBindGroupsCreatedLastFrame,lookupLastFrame:i.NumBindGroupsLookupLastFrame,noLookupLastFrame:i.NumBindGroupsNoLookupLastFrame}}static ResetCache(){i._Cache=new s,i.NumBindGroupsCreatedTotal=0,i.NumBindGroupsCreatedLastFrame=0,i.NumBindGroupsLookupLastFrame=0,i.NumBindGroupsNoLookupLastFrame=0,i._NumBindGroupsCreatedCurrentFrame=0,i._NumBindGroupsLookupCurrentFrame=0,i._NumBindGroupsNoLookupCurrentFrame=0}constructor(e,t,r){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=r}endFrame(){i.NumBindGroupsCreatedLastFrame=i._NumBindGroupsCreatedCurrentFrame,i.NumBindGroupsLookupLastFrame=i._NumBindGroupsLookupCurrentFrame,i.NumBindGroupsNoLookupLastFrame=i._NumBindGroupsNoLookupCurrentFrame,i._NumBindGroupsCreatedCurrentFrame=0,i._NumBindGroupsLookupCurrentFrame=0,i._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,r){let a,o=i._Cache;const u=this.disabled||r.forceBindGroupCreation;if(!u){if(!t.isDirty(r.updateId)&&!r.isDirty)return i._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const r of e.shaderProcessingContext.bufferNames){const e=t.buffers[r]?.uniqueId??0;let n=o.values[e];n||(n=new s,o.values[e]=n),o=n}for(const t of e.shaderProcessingContext.samplerNames){const e=r.samplers[t]?.hashCode??0;let n=o.values[e];n||(n=new s,o.values[e]=n),o=n}for(const t of e.shaderProcessingContext.textureNames){const e=r.textures[t]?.texture?.uniqueId??0;let n=o.values[e];n||(n=new s,o.values[e]=n),o=n}a=o.bindGroups}if(t.resetIsDirty(r.updateId),r.isDirty=!1,a)return t.bindGroups=a,i._NumBindGroupsLookupCurrentFrame++,a;a=[],t.bindGroups=a,u||(o.bindGroups=a),i.NumBindGroupsCreatedTotal++,i._NumBindGroupsCreatedCurrentFrame++;const c=e.bindGroupLayouts[r.textureState];for(let s=0;s<e.shaderProcessingContext.bindGroupLayoutEntries.length;s++){const i=e.shaderProcessingContext.bindGroupLayoutEntries[s],o=e.shaderProcessingContext.bindGroupEntries[s];for(let a=0;a<i.length;a++){const i=e.shaderProcessingContext.bindGroupLayoutEntries[s][a],u=e.shaderProcessingContext.bindGroupLayoutEntryInfo[s][i.binding],c=u.nameInArrayOfTexture??u.name;if(i.sampler){const e=r.samplers[c];if(e){const t=e.sampler;if(!t){this._engine.dbgSanityChecks&&n.V.Error(`Trying to bind a null sampler! entry=${JSON.stringify(i)}, name=${c}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${r.uniqueId}`,50);continue}o[a].resource=this._cacheSampler.getSampler(t,!1,e.hashCode,t.label)}else n.V.Error(`Sampler "${c}" could not be bound. entry=${JSON.stringify(i)}, materialContext=${JSON.stringify(r,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(i.texture||i.storageTexture){const e=r.textures[c];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){n.V.Error(`Trying to bind a null texture! entry=${JSON.stringify(i)}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${r.uniqueId}`,50);continue}const t=e.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!t||i.texture&&!t.view||i.storageTexture&&!t.viewForWriting)){n.V.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(i)}, name=${c}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, isReady=${e.texture?.isReady}, materialContext.uniqueId=${r.uniqueId}`,50);continue}o[a].resource=i.storageTexture?t.viewForWriting:t.view}else n.V.Error(`Texture "${c}" could not be bound. entry=${JSON.stringify(i)}, materialContext=${JSON.stringify(r,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(i.externalTexture){const e=r.textures[c];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){n.V.Error(`Trying to bind a null external texture! entry=${JSON.stringify(i)}, name=${c}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${r.uniqueId}`,50);continue}const t=e.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!t){n.V.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(i)}, name=${c}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, isReady=${e.texture?.isReady}, materialContext.uniqueId=${r.uniqueId}`,50);continue}o[a].resource=this._device.importExternalTexture({source:t})}else n.V.Error(`Texture "${c}" could not be bound. entry=${JSON.stringify(i)}, materialContext=${JSON.stringify(r,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(i.buffer){const e=t.buffers[c];if(e){const t=e.underlyingResource;o[a].resource.buffer=t,o[a].resource.size=e.capacity}else n.V.Error(`Can't find buffer "${c}". entry=${JSON.stringify(i)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}const u=c[s];a[s]=this._device.createBindGroup({layout:u,entries:o})}return a}}i.NumBindGroupsCreatedTotal=0,i.NumBindGroupsCreatedLastFrame=0,i.NumBindGroupsLookupLastFrame=0,i.NumBindGroupsNoLookupLastFrame=0,i._Cache=new s,i._NumBindGroupsCreatedCurrentFrame=0,i._NumBindGroupsLookupCurrentFrame=0,i._NumBindGroupsNoLookupCurrentFrame=0},6698:(e,t,r)=>{r.d(t,{V:()=>p});var n,s=r(9396),i=r(9738),a=r(2079),o=r(9177);!function(e){e[e.StencilReadMask=0]="StencilReadMask",e[e.StencilWriteMask=1]="StencilWriteMask",e[e.DepthBias=2]="DepthBias",e[e.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",e[e.DepthStencilState=4]="DepthStencilState",e[e.MRTAttachments1=5]="MRTAttachments1",e[e.MRTAttachments2=6]="MRTAttachments2",e[e.RasterizationState=7]="RasterizationState",e[e.ColorStates=8]="ColorStates",e[e.ShaderStage=9]="ShaderStage",e[e.TextureStage=10]="TextureStage",e[e.VertexState=11]="VertexState",e[e.NumStates=12]="NumStates"}(n||(n={}));const u={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},c={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};class l{constructor(e,t){this.mrtTextureCount=0,this._device=e,this._useTextureStage=!0,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=["bgra8unorm"],this.setColorFormat("bgra8unorm"),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat("depth24plus-stencil8"),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,r,n=0){if(r=i.m.GetSample(r),this.disabled){const s=l._GetTopology(e);return this._setVertexState(t),this._setTextureState(n),this._parameter.pipeline=this._createRenderPipeline(t,s,r),l.NumCacheMiss++,l._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,r),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(n),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,l.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return l.NumCacheHitWithHash++,this._parameter.pipeline;const s=l._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,s,r),this._setRenderPipeline(this._parameter),l.NumCacheMiss++,l._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){l.NumPipelineCreationLastFrame=l._NumPipelineCreationCurrentFrame,l._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,r,n,s,i,a,o){this._depthWriteEnabled=a,this._depthTestEnabled=i,this._depthCompare=(o??519)-512,this._cullFace=r,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(n),this.setDepthBias(s)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[n.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[n.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=a.g[e??""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let r=0;r<e.length;++r)0!==e[r]&&(t+=1<<r);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.MRTAttachments1))}setMRT(e,t){if((t=t??e.length)>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;const r=[0,0];let s=0,i=0,o=0;for(let n=0;n<t;++n){const t=e[n],u=t?._hardwareTexture;this._mrtFormats[o]=u?.format??this._webgpuColorFormat[0],r[s]+=a.g[this._mrtFormats[o]??""]<<i,i+=6,o++,i>=32&&(i=0,s++)}this._mrtFormats.length=o,this._mrtAttachments1===r[0]&&this._mrtAttachments2===r[1]||(this._mrtAttachments1=r[0],this._mrtAttachments2=r[1],this._states[n.MRTAttachments1]=r[0],this._states[n.MRTAttachments2]=r[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.MRTAttachments1))}setAlphaBlendEnabled(e){this._alphaBlendEnabled=e}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=void 0===e?0:a.g[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(e??519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(e??519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=null===e?1:c[e]}setStencilPassOp(e){this._stencilFrontPassOp=null===e?2:c[e]}setStencilFailOp(e){this._stencilFrontFailOp=null===e?1:c[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[n.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[n.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,r,n,s,i,a){this._stencilEnabled=e,this._stencilFrontCompare=(t??519)-512,this._stencilFrontDepthFailOp=null===r?1:c[r],this._stencilFrontPassOp=null===n?2:c[n],this._stencilFrontFailOp=null===s?1:c[s],this.setStencilReadMask(i),this.setStencilWriteMask(a)}setBuffers(e,t,r){this._vertexBuffers=e,this._overrideVertexBuffers=r,this._indexBuffer=t}static _GetTopology(e){switch(e){case 0:default:return"triangle-list";case 2:case 3:return"point-list";case 1:case 4:return"line-list";case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return"line-strip";case 7:return"triangle-strip";case 8:throw"TriangleFan is an unsupported fillmode in WebGPU"}}static _GetAphaBlendOperation(e){switch(e){case 32774:default:return"add";case 32778:return"subtract";case 32779:return"reverse-subtract";case 32775:return"min";case 32776:return"max"}}static _GetAphaBlendFactor(e){switch(e){case 0:return"zero";case 1:default:return"one";case 768:return"src";case 769:return"one-minus-src";case 770:return"src-alpha";case 771:return"one-minus-src-alpha";case 772:return"dst-alpha";case 773:return"one-minus-dst-alpha";case 774:return"dst";case 775:return"one-minus-dst";case 776:return"src-alpha-saturated";case 32769:case 32771:return"constant";case 32770:case 32772:return"one-minus-constant"}}static _GetCompareFunction(e){switch(e){case 0:return"never";case 1:return"less";case 2:return"equal";case 3:return"less-equal";case 4:return"greater";case 5:return"not-equal";case 6:return"greater-equal";case 7:return"always"}return"never"}static _GetStencilOpFunction(e){switch(e){case 0:return"zero";case 1:return"keep";case 2:return"replace";case 3:return"increment-clamp";case 4:return"decrement-clamp";case 5:return"invert";case 6:return"increment-wrap";case 7:return"decrement-wrap"}return"keep"}static _GetVertexInputDescriptorFormat(e){const t=e.type,r=e.normalized,n=e.getSize();switch(t){case s.R.BYTE:switch(n){case 1:case 2:return r?"snorm8x2":"sint8x2";case 3:case 4:return r?"snorm8x4":"sint8x4"}break;case s.R.UNSIGNED_BYTE:switch(n){case 1:case 2:return r?"unorm8x2":"uint8x2";case 3:case 4:return r?"unorm8x4":"uint8x4"}break;case s.R.SHORT:switch(n){case 1:case 2:return r?"snorm16x2":"sint16x2";case 3:case 4:return r?"snorm16x4":"sint16x4"}break;case s.R.UNSIGNED_SHORT:switch(n){case 1:case 2:return r?"unorm16x2":"uint16x2";case 3:case 4:return r?"unorm16x4":"uint16x4"}break;case s.R.INT:switch(n){case 1:return"sint32";case 2:return"sint32x2";case 3:return"sint32x3";case 4:return"sint32x4"}break;case s.R.UNSIGNED_INT:switch(n){case 1:return"uint32";case 2:return"uint32x2";case 3:return"uint32x3";case 4:return"uint32x4"}break;case s.R.FLOAT:switch(n){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4"}}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${r}, size=${n}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:l._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:l._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:l._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:l._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:l._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:l._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[n.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.ShaderStage))}_setRasterizationState(e,t){const r=this._frontFace-1+((this._cullEnabled?this._cullFace:0)<<1)+((this._clampDepth?1:0)<<3)+((this._alphaToCoverageEnabled?1:0)<<4)+(e<<5)+(t<<8);this._rasterizationState!==r&&(this._rasterizationState=r,this._states[n.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.RasterizationState))}_setColorStates(){let e=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(e+=(0|(null===this._alphaBlendFuncParams[0]?2:u[this._alphaBlendFuncParams[0]]))+((null===this._alphaBlendFuncParams[1]?2:u[this._alphaBlendFuncParams[1]])<<4)+((null===this._alphaBlendFuncParams[2]?2:u[this._alphaBlendFuncParams[2]])<<8)+((null===this._alphaBlendFuncParams[3]?2:u[this._alphaBlendFuncParams[3]])<<12)+((null===this._alphaBlendEqParams[0]?1:this._alphaBlendEqParams[0]-32773)<<16)+((null===this._alphaBlendEqParams[1]?1:this._alphaBlendEqParams[1]-32773)<<19)),e!==this._colorStates&&(this._colorStates=e,this._states[n.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.ColorStates))}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(e<<10);this._depthStencilState!==t&&(this._depthStencilState=t,this._states[n.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.DepthStencilState))}_setVertexState(e){const t=this._statesLength;let r=n.VertexState;const s=e._pipelineContext,i=s.shaderProcessingContext.attributeNamesFromEffect,a=s.shaderProcessingContext.attributeLocationsFromEffect;let o,u=0;for(let e=0;e<i.length;e++){const t=a[e];let n=(this._overrideVertexBuffers&&this._overrideVertexBuffers[i[e]])??this._vertexBuffers[i[e]];n||(n=this._emptyVertexBuffer);const s=n.effectiveBuffer?.underlyingResource;if(void 0===n._validOffsetRange){const e=n.effectiveByteOffset,t=n.getSize(!0),r=n.effectiveByteStride;n._validOffsetRange=e+t<=this._kMaxVertexBufferStride&&0===r||0!==r&&e+t<=r}o&&o===s&&n._validOffsetRange||(this.vertexBuffers[u++]=n,o=n._validOffsetRange?s:null);const c=n.hashCode+(t<<7);this._isDirty=this._isDirty||this._states[r]!==c,this._states[r++]=c}this.vertexBuffers.length=u,this._statesLength=r,this._isDirty=this._isDirty||r!==t,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[n.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,n.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],r=e.shaderProcessingContext.bindGroupLayoutEntries;for(let e=0;e<r.length;e++){const n=r[e];t[e]=this._device.createBindGroupLayout({entries:n})}return e.bindGroupLayouts[0]=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){const t=e.shaderProcessingContext,r=t.bindGroupLayoutEntries;let n=1;for(let e=0;e<r.length;e++){const s=r[e];for(let i=0;i<s.length;i++){const s=r[e][i];if(s.texture){const i=t.bindGroupLayoutEntryInfo[e][s.binding].name,a=t.availableTextures[i],o=a.autoBindSampler?t.availableSamplers[i+"Sampler"]:null;let u=a.sampleType,c=o?.type??"filtering";if(this._textureState&n&&"depth"!==u&&(a.autoBindSampler&&(c="non-filtering"),u="unfilterable-float"),s.texture.sampleType=u,o){const e=t.bindGroupLayoutEntryInfo[o.binding.groupIndex][o.binding.bindingIndex].index;r[o.binding.groupIndex][e].sampler.type=c}n<<=1}}}const s=[];for(let e=0;e<r.length;++e)s[e]=this._device.createBindGroupLayout({entries:r[e]});return e.bindGroupLayouts[this._textureState]=s,this._device.createPipelineLayout({bindGroupLayouts:s})}_getVertexInputDescriptor(e){const t=[],r=e._pipelineContext,n=r.shaderProcessingContext.attributeNamesFromEffect,s=r.shaderProcessingContext.attributeLocationsFromEffect;let i,a;for(let e=0;e<n.length;e++){const r=s[e];let o=(this._overrideVertexBuffers&&this._overrideVertexBuffers[n[e]])??this._vertexBuffers[n[e]];o||(o=this._emptyVertexBuffer);let u=o.effectiveBuffer?.underlyingResource,c=o.effectiveByteOffset;const h=!o._validOffsetRange;if(!i||!a||i!==u||h){const e={arrayStride:o.effectiveByteStride,stepMode:o.getIsInstanced()?"instance":"vertex",attributes:[]};t.push(e),a=e.attributes,h&&(c=0,u=null)}a.push({shaderLocation:r,offset:c,format:l._GetVertexInputDescriptorFormat(o)}),i=u}return t}_createRenderPipeline(e,t,r){const n=e._pipelineContext,s=this._getVertexInputDescriptor(e),a=this._createPipelineLayout(n),u=[],c=this._getAphaBlendState(),h=this._getColorBlendState();if(this._vertexBuffers&&(0,o.z)(this._vertexBuffers,e),this._mrtAttachments1>0)for(let e=0;e<this._mrtFormats.length;++e){const t=this._mrtFormats[e];if(t){const r={format:t,writeMask:this._mrtEnabledMask&1<<e?this._writeMask:0};c&&h&&(r.blend={alpha:c,color:h}),u.push(r)}else u.push(null)}else if(this._webgpuColorFormat[0]){const e={format:this._webgpuColorFormat[0],writeMask:this._writeMask};c&&h&&(e.blend={alpha:c,color:h}),u.push(e)}else u.push(null);const p={compare:l._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:l._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:l._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:l._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};let d;"line-strip"!==t&&"triangle-strip"!==t||(d=!this._indexBuffer||this._indexBuffer.is32Bits?"uint32":"uint16");const g=!!this._webgpuDepthStencilFormat&&i.m.HasStencilAspect(this._webgpuDepthStencilFormat);return this._device.createRenderPipeline({label:`RenderPipeline_${u[0]?.format??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${r}_textureState${this._textureState}`,layout:a,vertex:{module:n.stages.vertexStage.module,entryPoint:n.stages.vertexStage.entryPoint,buffers:s},primitive:{topology:t,stripIndexFormat:d,frontFace:1===this._frontFace?"ccw":"cw",cullMode:this._cullEnabled?2===this._cullFace?"front":"back":"none"},fragment:n.stages.fragmentStage?{module:n.stages.fragmentStage.module,entryPoint:n.stages.fragmentStage.entryPoint,targets:u}:void 0,multisample:{count:r},depthStencil:void 0===this._webgpuDepthStencilFormat?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?l._GetCompareFunction(this._depthCompare):"always",format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&g?p:void 0,stencilBack:this._stencilEnabled&&g?p:void 0,stencilReadMask:this._stencilEnabled&&g?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&g?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}l.NumCacheHitWithoutHash=0,l.NumCacheHitWithHash=0,l.NumCacheMiss=0,l.NumPipelineCreationLastFrame=0,l._NumPipelineCreationCurrentFrame=0;class h{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const r in this.values){const n=this.values[r],[s,i]=n.count();e+=s,t+=i,e++}return[e,t]}}class p extends l{static GetNodeCounts(){const e=p._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,r,n){if(e.pipeline){const e=r.slice();e.length=n,t.push(e)}for(const s in e.values){const i=e.values[s];r[n]=parseInt(s),p._GetPipelines(i,t,r,n+1)}}static GetPipelines(){const e=[];return p._GetPipelines(p._Cache,e,[],0),e}static ResetCache(){p._Cache=new h}reset(){this._nodeStack=[],this._nodeStack[0]=p._Cache,super.reset()}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let e=this._stateDirtyLowestIndex;e<this._statesLength;++e){let r=t.values[this._states[e]];r||(r=new h,t.values[this._states[e]]=r),t=r,this._nodeStack[e+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}p._Cache=new h},6427:(e,t,r)=>{r.d(t,{R:()=>a});const n=[0,0,3,7,0,2,6,2,4,1,5,3,1],s=[0,64,32,96,16,80,48,112,8],i=[0,128,128,0,0,0,0,128,0,0,0,0,128];class a{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){const t=e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1;return n[e.samplingMode]+s[(e._comparisonFunction||514)-512+1]+i[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,t){let r,n,s,i,a;const o=e.useMipMaps;switch(e.samplingMode){case 11:r="linear",n="linear",s="nearest",o||(i=a=0);break;case 3:case 3:r="linear",n="linear",o?s="linear":(s="nearest",i=a=0);break;case 8:r="nearest",n="nearest",o?s="linear":(s="nearest",i=a=0);break;case 4:r="nearest",n="nearest",s="nearest",o||(i=a=0);break;case 5:r="nearest",n="linear",s="nearest",o||(i=a=0);break;case 6:r="nearest",n="linear",o?s="linear":(s="nearest",i=a=0);break;case 7:r="nearest",n="linear",s="nearest",i=a=0;break;case 1:case 1:default:r="nearest",n="nearest",s="nearest",i=a=0;break;case 9:r="linear",n="nearest",s="nearest",o||(i=a=0);break;case 10:r="linear",n="nearest",o?s="linear":(s="nearest",i=a=0);break;case 2:case 2:r="linear",n="linear",s="nearest",i=a=0;break;case 12:r="linear",n="nearest",s="nearest",i=a=0}return t>1&&(0!==i||0!==a)&&"nearest"!==s?{magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",anisotropyEnabled:!0}:{magFilter:r,minFilter:n,mipmapFilter:s,lodMinClamp:i,lodMaxClamp:a}}static _GetWrappingMode(e){switch(e){case 1:return"repeat";case 0:return"clamp-to-edge";case 2:return"mirror-repeat"}return"repeat"}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){const r=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,n=this._GetSamplerFilterDescriptor(e,r);return{label:t,...n,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?a.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:n.anisotropyEnabled?r:1}}static GetCompareFunction(e){switch(e){case 519:return"always";case 514:return"equal";case 516:return"greater";case 518:return"greater-equal";case 513:default:return"less";case 515:return"less-equal";case 512:return"never";case 517:return"not-equal"}}getSampler(e,t=!1,r=0,n){if(this.disabled)return this._device.createSampler(a._GetSamplerDescriptor(e,n));t?r=0:0===r&&(r=a.GetSamplerHashCode(e));let s=t?void 0:this._samplers[r];return s||(s=this._device.createSampler(a._GetSamplerDescriptor(e,n)),t||(this._samplers[r]=s)),s}}},6511:(e,t,r)=>{r.d(t,{N:()=>o});var n=r(6698),s=r(7436),i=r(9738),a=r(2079);r(2672),r(8826);class o{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,r){this._cacheRenderPipeline.setMRT(t,r),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,r){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new n.V(this._device,r),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1)}clear(e,t,r,n,o=1){let u,c,l=null;const h=!!this._engine._currentRenderTarget;if(e)u=e;else{let e=0;this._keyTemp.length=0;for(let t=0;t<this._cacheRenderPipeline.colorFormats.length;++t)this._keyTemp[e++]=a.g[this._cacheRenderPipeline.colorFormats[t]??""];const s=a.g[this._depthTextureFormat??0];if(this._keyTemp[e]=(t?t.r+256*t.g+256*t.b*256+256*t.a*256*256:0)+(r?2**32:0)+(n?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(h?2**35:0)+(o>1?2**36:0)+s*2**37,c=this._keyTemp.join("_"),l=this._bundleCache[c],l)return l;u=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:i.m.GetSample(o)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!r),this._cacheRenderPipeline.setStencilEnabled(!!n&&!!this._depthTextureFormat&&i.m.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(n?255:0),this._cacheRenderPipeline.setStencilCompare(n?519:512),this._cacheRenderPipeline.setStencilPassOp(n?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const p=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,o),d=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),d.uniformBuffer.update();const g=h?this._engine._ubInvertY:this._engine._ubDontInvertY,m=d.uniformBuffer.getBuffer(),f=m.uniqueId+"-"+g.uniqueId;let _=this._bindGroups[f];if(!_){const e=d.bindGroupLayouts[0];_=this._bindGroups[f]=[],_.push(this._device.createBindGroup({label:`clearQuadBindGroup0-${f}`,layout:e[0],entries:[]})),s.E._SimplifiedKnownBindings||_.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${f}`,layout:e[1],entries:[]})),_.push(this._device.createBindGroup({label:`clearQuadBindGroup${s.E._SimplifiedKnownBindings?1:2}-${f}`,layout:e[s.E._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:g.underlyingResource,size:g.capacity}},{binding:1,resource:{buffer:m.underlyingResource,size:m.capacity}}]}))}u.setPipeline(p);for(let e=0;e<_.length;++e)u.setBindGroup(e,_[e]);return u.draw(4,1,0,0),e||(l=u.finish(),this._bundleCache[c]=l),l}}},2455:(e,t,r)=>{var n,s,i,a,o,u,c,l,h,p,d,g,m,f,_,b,x,y,S,v,I,B,w,T,C,F,G,D,A,P,R,L,M,E,U,O,$,N,W,k;r.d(t,{Sd:()=>a}),function(e){e.LowPower="low-power",e.HighPerformance="high-performance"}(n||(n={})),function(e){e.DepthClipControl="depth-clip-control",e.Depth32FloatStencil8="depth32float-stencil8",e.TextureCompressionBC="texture-compression-bc",e.TextureCompressionETC2="texture-compression-etc2",e.TextureCompressionASTC="texture-compression-astc",e.TimestampQuery="timestamp-query",e.IndirectFirstInstance="indirect-first-instance",e.ShaderF16="shader-f16",e.RG11B10UFloatRenderable="rg11b10ufloat-renderable",e.BGRA8UnormStorage="bgra8unorm-storage",e.Float32Filterable="float32-filterable"}(s||(s={})),function(e){e.Unmapped="unmapped",e.Pending="pending",e.Mapped="mapped"}(i||(i={})),function(e){e[e.MapRead=1]="MapRead",e[e.MapWrite=2]="MapWrite",e[e.CopySrc=4]="CopySrc",e[e.CopyDst=8]="CopyDst",e[e.Index=16]="Index",e[e.Vertex=32]="Vertex",e[e.Uniform=64]="Uniform",e[e.Storage=128]="Storage",e[e.Indirect=256]="Indirect",e[e.QueryResolve=512]="QueryResolve"}(a||(a={})),function(e){e[e.Read=1]="Read",e[e.Write=2]="Write"}(o||(o={})),function(e){e.E1d="1d",e.E2d="2d",e.E3d="3d"}(u||(u={})),function(e){e[e.CopySrc=1]="CopySrc",e[e.CopyDst=2]="CopyDst",e[e.TextureBinding=4]="TextureBinding",e[e.StorageBinding=8]="StorageBinding",e[e.RenderAttachment=16]="RenderAttachment"}(c||(c={})),function(e){e.E1d="1d",e.E2d="2d",e.E2dArray="2d-array",e.Cube="cube",e.CubeArray="cube-array",e.E3d="3d"}(l||(l={})),function(e){e.All="all",e.StencilOnly="stencil-only",e.DepthOnly="depth-only"}(h||(h={})),function(e){e.R8Unorm="r8unorm",e.R8Snorm="r8snorm",e.R8Uint="r8uint",e.R8Sint="r8sint",e.R16Uint="r16uint",e.R16Sint="r16sint",e.R16Float="r16float",e.RG8Unorm="rg8unorm",e.RG8Snorm="rg8snorm",e.RG8Uint="rg8uint",e.RG8Sint="rg8sint",e.R32Uint="r32uint",e.R32Sint="r32sint",e.R32Float="r32float",e.RG16Uint="rg16uint",e.RG16Sint="rg16sint",e.RG16Float="rg16float",e.RGBA8Unorm="rgba8unorm",e.RGBA8UnormSRGB="rgba8unorm-srgb",e.RGBA8Snorm="rgba8snorm",e.RGBA8Uint="rgba8uint",e.RGBA8Sint="rgba8sint",e.BGRA8Unorm="bgra8unorm",e.BGRA8UnormSRGB="bgra8unorm-srgb",e.RGB9E5UFloat="rgb9e5ufloat",e.RGB10A2UINT="rgb10a2uint",e.RGB10A2Unorm="rgb10a2unorm",e.RG11B10UFloat="rg11b10ufloat",e.RG32Uint="rg32uint",e.RG32Sint="rg32sint",e.RG32Float="rg32float",e.RGBA16Uint="rgba16uint",e.RGBA16Sint="rgba16sint",e.RGBA16Float="rgba16float",e.RGBA32Uint="rgba32uint",e.RGBA32Sint="rgba32sint",e.RGBA32Float="rgba32float",e.Stencil8="stencil8",e.Depth16Unorm="depth16unorm",e.Depth24Plus="depth24plus",e.Depth24PlusStencil8="depth24plus-stencil8",e.Depth32Float="depth32float",e.BC1RGBAUnorm="bc1-rgba-unorm",e.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",e.BC2RGBAUnorm="bc2-rgba-unorm",e.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",e.BC3RGBAUnorm="bc3-rgba-unorm",e.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",e.BC4RUnorm="bc4-r-unorm",e.BC4RSnorm="bc4-r-snorm",e.BC5RGUnorm="bc5-rg-unorm",e.BC5RGSnorm="bc5-rg-snorm",e.BC6HRGBUFloat="bc6h-rgb-ufloat",e.BC6HRGBFloat="bc6h-rgb-float",e.BC7RGBAUnorm="bc7-rgba-unorm",e.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",e.ETC2RGB8Unorm="etc2-rgb8unorm",e.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",e.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",e.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",e.ETC2RGBA8Unorm="etc2-rgba8unorm",e.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",e.EACR11Unorm="eac-r11unorm",e.EACR11Snorm="eac-r11snorm",e.EACRG11Unorm="eac-rg11unorm",e.EACRG11Snorm="eac-rg11snorm",e.ASTC4x4Unorm="astc-4x4-unorm",e.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",e.ASTC5x4Unorm="astc-5x4-unorm",e.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",e.ASTC5x5Unorm="astc-5x5-unorm",e.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",e.ASTC6x5Unorm="astc-6x5-unorm",e.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",e.ASTC6x6Unorm="astc-6x6-unorm",e.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",e.ASTC8x5Unorm="astc-8x5-unorm",e.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",e.ASTC8x6Unorm="astc-8x6-unorm",e.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",e.ASTC8x8Unorm="astc-8x8-unorm",e.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",e.ASTC10x5Unorm="astc-10x5-unorm",e.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",e.ASTC10x6Unorm="astc-10x6-unorm",e.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",e.ASTC10x8Unorm="astc-10x8-unorm",e.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",e.ASTC10x10Unorm="astc-10x10-unorm",e.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",e.ASTC12x10Unorm="astc-12x10-unorm",e.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",e.ASTC12x12Unorm="astc-12x12-unorm",e.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",e.Depth32FloatStencil8="depth32float-stencil8"}(p||(p={})),function(e){e.ClampToEdge="clamp-to-edge",e.Repeat="repeat",e.MirrorRepeat="mirror-repeat"}(d||(d={})),function(e){e.Nearest="nearest",e.Linear="linear"}(g||(g={})),function(e){e.Nearest="nearest",e.Linear="linear"}(m||(m={})),function(e){e.Never="never",e.Less="less",e.Equal="equal",e.LessEqual="less-equal",e.Greater="greater",e.NotEqual="not-equal",e.GreaterEqual="greater-equal",e.Always="always"}(f||(f={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Compute=4]="Compute"}(_||(_={})),function(e){e.Uniform="uniform",e.Storage="storage",e.ReadOnlyStorage="read-only-storage"}(b||(b={})),function(e){e.Filtering="filtering",e.NonFiltering="non-filtering",e.Comparison="comparison"}(x||(x={})),function(e){e.Float="float",e.UnfilterableFloat="unfilterable-float",e.Depth="depth",e.Sint="sint",e.Uint="uint"}(y||(y={})),function(e){e.WriteOnly="write-only",e.ReadOnly="read-only",e.ReadWrite="read-write"}(S||(S={})),function(e){e.Error="error",e.Warning="warning",e.Info="info"}(v||(v={})),function(e){e.Validation="validation",e.Internal="internal"}(I||(I={})),function(e){e.Auto="auto"}(B||(B={})),function(e){e.PointList="point-list",e.LineList="line-list",e.LineStrip="line-strip",e.TriangleList="triangle-list",e.TriangleStrip="triangle-strip"}(w||(w={})),function(e){e.CCW="ccw",e.CW="cw"}(T||(T={})),function(e){e.None="none",e.Front="front",e.Back="back"}(C||(C={})),function(e){e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.Blue=4]="Blue",e[e.Alpha=8]="Alpha",e[e.All=15]="All"}(F||(F={})),function(e){e.Zero="zero",e.One="one",e.Src="src",e.OneMinusSrc="one-minus-src",e.SrcAlpha="src-alpha",e.OneMinusSrcAlpha="one-minus-src-alpha",e.Dst="dst",e.OneMinusDst="one-minus-dst",e.DstAlpha="dst-alpha",e.OneMinusDstAlpha="one-minus-dst-alpha",e.SrcAlphaSaturated="src-alpha-saturated",e.Constant="constant",e.OneMinusConstant="one-minus-constant"}(G||(G={})),function(e){e.Add="add",e.Subtract="subtract",e.ReverseSubtract="reverse-subtract",e.Min="min",e.Max="max"}(D||(D={})),function(e){e.Keep="keep",e.Zero="zero",e.Replace="replace",e.Invert="invert",e.IncrementClamp="increment-clamp",e.DecrementClamp="decrement-clamp",e.IncrementWrap="increment-wrap",e.DecrementWrap="decrement-wrap"}(A||(A={})),function(e){e.Uint16="uint16",e.Uint32="uint32"}(P||(P={})),function(e){e.Uint8x2="uint8x2",e.Uint8x4="uint8x4",e.Sint8x2="sint8x2",e.Sint8x4="sint8x4",e.Unorm8x2="unorm8x2",e.Unorm8x4="unorm8x4",e.Snorm8x2="snorm8x2",e.Snorm8x4="snorm8x4",e.Uint16x2="uint16x2",e.Uint16x4="uint16x4",e.Sint16x2="sint16x2",e.Sint16x4="sint16x4",e.Unorm16x2="unorm16x2",e.Unorm16x4="unorm16x4",e.Snorm16x2="snorm16x2",e.Snorm16x4="snorm16x4",e.Float16x2="float16x2",e.Float16x4="float16x4",e.Float32="float32",e.Float32x2="float32x2",e.Float32x3="float32x3",e.Float32x4="float32x4",e.Uint32="uint32",e.Uint32x2="uint32x2",e.Uint32x3="uint32x3",e.Uint32x4="uint32x4",e.Sint32="sint32",e.Sint32x2="sint32x2",e.Sint32x3="sint32x3",e.Sint32x4="sint32x4",e.UNORM10x10x10x2="unorm10-10-10-2"}(R||(R={})),function(e){e.Vertex="vertex",e.Instance="instance"}(L||(L={})),function(e){e.Beginning="beginning",e.End="end"}(M||(M={})),function(e){e.Beginning="beginning",e.End="end"}(E||(E={})),function(e){e.Load="load",e.Clear="clear"}(U||(U={})),function(e){e.Store="store",e.Discard="discard"}(O||(O={})),function(e){e.Occlusion="occlusion",e.Timestamp="timestamp"}($||($={})),function(e){e.Opaque="opaque",e.Premultiplied="premultiplied"}(N||(N={})),function(e){e.Unknown="unknown",e.Destroyed="destroyed"}(W||(W={})),function(e){e.Validation="validation",e.OutOfMemory="out-of-memory",e.Internal="internal"}(k||(k={}))},7793:(e,t,r)=>{r.d(t,{H:()=>s});var n=r(1879);class s extends n.N{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}},2200:(e,t,r)=>{r.d(t,{O:()=>s});var n=r(2455);class s{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get useInstancing(){return this._useInstancing}set useInstancing(e){this._useInstancing!==e&&(e?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,n.Sd.CopyDst|n.Sd.Indirect|n.Sd.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=e,this._currentInstanceCount=-1)}constructor(e){this._bufferManager=e,this.uniqueId=s._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(e,t){this._isDirty||(this._isDirty=t?.uniqueId!==this.buffers[e]?.uniqueId),this.buffers[e]=t}setIndirectData(e,t,r){t!==this._currentInstanceCount&&this.indirectDrawBuffer&&this._indirectDrawData&&(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=r,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}s._Counter=0},4675:(e,t,r)=>{r.d(t,{J:()=>s});var n=r(1352);class s extends n.r{constructor(e){super(e)}}},974:(e,t,r)=>{r.d(t,{Q:()=>i});var n=r(7020),s=r(9738);class i{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e=0){return this._webgpuMSAATexture?.[e]??null}setMSAATexture(e,t=-1){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),-1===t&&(t=this._webgpuMSAATexture.length),this._webgpuMSAATexture[t]=e}releaseMSAATexture(){if(this._webgpuMSAATexture){for(const e of this._webgpuMSAATexture)e?.destroy();this._webgpuMSAATexture=null}}constructor(e=null){this._originalFormatIsRGB=!1,this.format="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,r,i,a,o,u,c){let l="2d",h=1;i?(l=r?"cube-array":"cube",h=6*(c||1)):a?(l="3d",h=1):r&&(l="2d-array",h=c);const p=s.m.GetDepthFormatOnly(this.format),d=s.m.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${a?"3D":i?"Cube":"2D"}${r?"_Array"+h:""}_${o}x${u}_${t?"wmips":"womips"}_${this.format}_${l}`,format:p,dimension:l,mipLevelCount:t?n.X.ILog2(Math.max(o,u))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:h,aspect:d})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const t=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=t}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){this._webgpuTexture?.destroy(),this.releaseMSAATexture(),this._copyInvertYTempTexture?.destroy(),this.reset()}}},5813:(e,t,r)=>{r.d(t,{r:()=>i});var n=r(1352),s=r(6427);class i{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.uniqueId=i._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(e,t){let r=this.samplers[e],n=-1;r?n=r.hashCode:this.samplers[e]=r={sampler:t,hashCode:0},r.sampler=t,r.hashCode=t?s.R.GetSamplerHashCode(t):0;const i=n!==r.hashCode;i&&this.updateId++,this.isDirty||(this.isDirty=i)}setTexture(e,t){let r=this.textures[e],s=-1;r?s=r.texture?.uniqueId??-1:this.textures[e]=r={texture:t,isFloatOrDepthTexture:!1,isExternalTexture:!1},r.isExternalTexture&&this._numExternalTextures--,r.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,t?(r.isFloatOrDepthTexture=1===t.type||t.format>=13&&t.format<=18,r.isExternalTexture=n.r.IsExternalTexture(t),r.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,r.isExternalTexture&&this._numExternalTextures++):(r.isFloatOrDepthTexture=!1,r.isExternalTexture=!1),r.texture=t;const i=s!==(t?.uniqueId??-1);i&&this.updateId++,this.isDirty||(this.isDirty=i)}}i._Counter=0},1194:(e,t,r)=>{r.d(t,{e:()=>s});var n=r(8173);class s{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;const t=void 0!==this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,r,n=50,s=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=r,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=s,this._allocateNewIndices(n)}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){return Number(this._lastBuffer?.[e]??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then((e=>{this._lastBuffer=e})))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new n.L(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout((()=>e.dispose),1e3)}dispose(){this._querySet?.dispose(),this._availableIndices.length=0}}},6228:(e,t,r)=>{r.d(t,{e:()=>s});var n=r(9724);class s{constructor(){this._gpuTimeInFrameId=-1,this.counter=new n.A}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,!1),this._gpuTimeInFrameId=e):this.counter.addCount(t,!1))}}},7304:(e,t,r)=>{r.d(t,{s:()=>i});var n=r(2338),s=r(9594);class i{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,r,n,s,i,a,o){const u=this.engine;u._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");const c=this.shaderProcessingContext.availableTextures;let l;for(l=0;l<s.length;l++){const e=s[l],t=c[s[l]];null==t||null==t?(s.splice(l,1),l--):i[e]=l}for(const e of u.getAttributes(this,a))o.push(e);this.buildUniformLayout();const h=[],p=[];for(l=0;l<a.length;l++){const e=o[l];e>=0&&(h.push(a[l]),p.push(e))}this.shaderProcessingContext.attributeNamesFromEffect=h,this.shaderProcessingContext.attributeLocationsFromEffect=p}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new n.D(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),r=s.q.UniformSizes[t];this.uniformBuffer.addUniform(e.name,r,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}setEngine(e){this.engine=e}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt(e,t)}setInt2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt2(e,t,r)}setInt3(e,t,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt3(e,t,r,n)}setInt4(e,t,r,n,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt4(e,t,r,n,s)}setIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt2(e,t,r)}setUInt3(e,t,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt3(e,t,r,n)}setUInt4(e,t,r,n,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt4(e,t,r,n,s)}setUIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat2(e,t,r)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat3(e,t,r,n)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,r,n,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat4(e,t,r,n,s)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,r){this.setFloat4(e,t.r,t.g,t.b,r)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.sources?.vertex}_getFragmentShaderCode(){return this.sources?.fragment}}},8173:(e,t,r)=>{r.d(t,{L:()=>s});var n=r(2455);class s{get querySet(){return this._querySet}constructor(e,t,r,s,i,a=!0,o){this._dstBuffers=[],this._engine=e,this._device=s,this._bufferManager=i,this._count=t,this._canUseMultipleBuffers=a,this._querySet=s.createQuerySet({label:o??"QuerySet",type:r,count:t}),this._queryBuffer=i.createRawBuffer(8*t,n.Sd.QueryResolve|n.Sd.CopySrc,void 0,"QueryBuffer"),a||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,n.Sd.MapRead|n.Sd.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;const r=this._device.createCommandEncoder();let s;return 0===this._dstBuffers.length?s=this._bufferManager.createRawBuffer(8*this._count,n.Sd.MapRead|n.Sd.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(s=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),r.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),r.copyBufferToBuffer(this._queryBuffer,0,s,0,8*t),this._device.queue.submit([r.finish()]),s}async readValues(e=0,t=1){const r=this._getBuffer(e,t);if(null===r)return null;const n=this._engine.uniqueId;return r.mapAsync(1).then((()=>{const e=new BigUint64Array(r.getMappedRange()).slice();return r.unmap(),this._dstBuffers[this._dstBuffers.length]=r,e}),(e=>{if(this._engine.isDisposed||this._engine.uniqueId!==n)return null;throw e}))}async readValue(e=0){const t=this._getBuffer(e,1);if(null===t)return null;const r=this._engine.uniqueId;return t.mapAsync(1).then((()=>{const e=new BigUint64Array(t.getMappedRange()),r=Number(e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,r}),(e=>{if(this._engine.isDisposed||this._engine.uniqueId!==r)return 0;throw e}))}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(null===t)return null;const r=this._engine.uniqueId;return t.mapAsync(1).then((()=>{const e=new BigUint64Array(t.getMappedRange()),r=Number(e[1]-e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,r}),(e=>{if(this._engine.isDisposed||this._engine.uniqueId!==r)return 0;throw e}))}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}},7436:(e,t,r)=>{r.d(t,{E:()=>s});const n={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class s{static get KnownUBOs(){return s._SimplifiedKnownBindings?s._SimplifiedKnownUBOs:s._KnownUBOs}constructor(e,t=!1){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],t||this._findStartingGroupBinding()}_findStartingGroupBinding(){const e=s.KnownUBOs,t=[];for(const r in e){const n=e[r].binding;-1!==n.groupIndex&&(void 0===t[n.groupIndex]?t[n.groupIndex]=n.bindingIndex:t[n.groupIndex]=Math.max(t[n.groupIndex],n.bindingIndex))}this.freeGroupIndex=t.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){const r=this._attributeNextLocation;return this._attributeNextLocation+=(n[e]??1)*(t||1),r}getVaryingNextLocation(e,t=0){const r=this._varyingNextLocation;return this._varyingNextLocation+=(n[e]??1)*(t||1),r}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>65536-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}s._SimplifiedKnownBindings=!0,s._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},s._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}}},9594:(e,t,r)=>{r.d(t,{q:()=>n});class n{constructor(){this.shaderLanguage=0}_addUniformToLeftOverUBO(e,t,r){let n=0;[e,t,n]=this._getArraySize(e,t,r);for(let t=0;t<this._webgpuProcessingContext.leftOverUniforms.length;t++)if(this._webgpuProcessingContext.leftOverUniforms[t].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:n})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=n.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,"uniform",!0),this._addBufferBindingDescription(e,t,"uniform",!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(void 0!==t)for(let r=0;r<t.length;r++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e][r],n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].name,s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].nameInArrayOfTexture;t&&(t.texture||t.externalTexture||t.storageTexture?this._webgpuProcessingContext.textureNames.push(s):t.sampler?this._webgpuProcessingContext.samplerNames.push(n):t.buffer&&this._webgpuProcessingContext.bufferNames.push(n))}else this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[]}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[t],n=[];for(let e=0;e<r.length;e++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[t][e];r.sampler||r.texture||r.storageTexture||r.externalTexture?n.push({binding:r.binding,resource:void 0}):r.buffer&&n.push({binding:r.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=n}}_addTextureBindingDescription(e,t,r,n,s,i){let{groupIndex:a,bindingIndex:o}=t.textures[r];if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]){let i;i=null===n?this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,externalTexture:{}}):s?this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,storageTexture:{access:"write-only",format:s,viewDimension:n}}):this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,texture:{sampleType:t.sampleType,viewDimension:n,multisampled:!1}});const u=t.isTextureArray?e+r:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]={name:e,index:i-1,nameInArrayOfTexture:u}}o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o].index,this._webgpuProcessingContext.bindGroupLayoutEntries[a][o].visibility|=i?1:2}_addSamplerBindingDescription(e,t,r){let{groupIndex:n,bindingIndex:s}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s]){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:s,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s]={name:e,index:r-1}}s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s].index,this._webgpuProcessingContext.bindGroupLayoutEntries[n][s].visibility|=r?1:2}_addBufferBindingDescription(e,t,r,n){let{groupIndex:s,bindingIndex:i}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][i]){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:i,visibility:0,buffer:{type:r}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][i]={name:e,index:t-1}}i=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][i].index,this._webgpuProcessingContext.bindGroupLayoutEntries[s][i].visibility|=n?1:2}}n.LeftOvertUBOName="LeftOver",n.InternalsUBOName="Internals",n.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2},n._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},n._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},n._GpuTextureViewDimensionByWebGPUTextureType={textureCube:"cube",textureCubeArray:"cube-array",texture2D:"2d",texture2DArray:"2d-array",texture3D:"3d"},n._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},n._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1}},9685:(e,t,r)=>{r.d(t,{I:()=>o});var n=r(7436),s=r(461),i=r(9594),a=r(2118);class o extends i.q{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=0,this.parseGLES3=!0}_getArraySize(e,t,r){let n=0;const s=e.indexOf("["),i=e.indexOf("]");if(s>0&&i>0){const t=e.substring(s+1,i);n=+t,isNaN(n)&&(n=+r[t.trim()]),e=e.substr(0,s)}return[e,t,n]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const r=`// Internals UBO\nuniform ${i.q.InternalsUBOName} {\nfloat yFactor_;\nfloat textureOutputHeight_;\n};\n`,n=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),n?e:r+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),n?e:r+e)}varyingCheck(e,t){return(t&&this._fragmentIsGLES3?/(flat\s)?\s*\bin\b/:!t&&this._vertexIsGLES3?/(flat\s)?\s*\bout\b/:/(flat\s)?\s*\bvarying\b/).test(e)}varyingProcessor(e,t,r){this._preProcessors=r;const n=(t&&this._fragmentIsGLES3?/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==n){const i=n[1]??"",a=n[2],o=n[3];let u;t?(u=this._webgpuProcessingContext.availableVaryings[o],this._missingVaryings[u]="",void 0===u&&s.V.Warn(`Invalid fragment shader: The varying named "${o}" is not declared in the vertex shader! This declaration will be ignored.`)):(u=this._webgpuProcessingContext.getVaryingNextLocation(a,this._getArraySize(o,a,r)[2]),this._webgpuProcessingContext.availableVaryings[o]=u,this._missingVaryings[u]=`layout(location = ${u}) ${i} in ${a} ${o};`),e=e.replace(n[0],void 0===u?"":`layout(location = ${u}) ${i} ${t?"in":"out"} ${a} ${o};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const r=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==r){const n=r[1],s=r[2],i=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(s,n,t)[2]);this._webgpuProcessingContext.availableAttributes[s]=i,this._webgpuProcessingContext.orderedAttributes[i]=s;const a=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[s];if(void 0!==a){const t=a<0?-1===a?"int":"ivec"+-a:1===a?"uint":"uvec"+a,o=`_int_${s}_`;e=e.replace(r[0],`layout(location = ${i}) in ${t} ${o}; ${n} ${s} = ${n}(${o});`)}else e=e.replace(r[0],`layout(location = ${i}) in ${n} ${s};`)}return e}uniformProcessor(e,t,r){this._preProcessors=r;const n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==n){let s=n[1],a=n[2];if(0===s.indexOf("sampler")||1===s.indexOf("sampler")){let n=0;[a,s,n]=this._getArraySize(a,s,r);let o=this._webgpuProcessingContext.availableTextures[a];if(!o){o={autoBindSampler:!0,isTextureArray:n>0,isStorageTexture:!1,textures:[],sampleType:"float"};for(let e=0;e<(n||1);++e)o.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const u=i.q._SamplerTypeByWebGLSamplerType[s]??"sampler",c=!!i.q._IsComparisonSamplerByWebGPUSamplerType[u],l=c?"comparison":"filtering",h=a+"Sampler";let p=this._webgpuProcessingContext.availableSamplers[h];p||(p={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l});const d="u"===s.charAt(0)?"u":"i"===s.charAt(0)?"i":"";d&&(s=s.substr(1));const g=c?"depth":"u"===d?"uint":"i"===d?"sint":"float";o.sampleType=g;const m=n>0,f=p.binding.groupIndex,_=p.binding.bindingIndex,b=i.q._SamplerFunctionByWebGLSamplerType[s],x=i.q._TextureTypeByWebGLSamplerType[s],y=i.q._GpuTextureViewDimensionByWebGPUTextureType[x];if(m){const t=[];t.push(`layout(set = ${f}, binding = ${_}) uniform ${d}${u} ${h};`),e="\n";for(let r=0;r<n;++r){const n=o.textures[r].groupIndex,s=o.textures[r].bindingIndex;t.push(`layout(set = ${n}, binding = ${s}) uniform ${x} ${a}Texture${r};`),e+=`${r>0?"\n":""}#define ${a}${r} ${d}${b}(${a}Texture${r}, ${h})`}e=t.join("\n")+e,this._textureArrayProcessing.push(a)}else n=1,e=`layout(set = ${f}, binding = ${_}) uniform ${u} ${h};\n                        layout(set = ${o.textures[0].groupIndex}, binding = ${o.textures[0].bindingIndex}) uniform ${d}${x} ${a}Texture;\n                        #define ${a} ${d}${b}(${a}Texture, ${h})`;this._webgpuProcessingContext.availableTextures[a]=o,this._webgpuProcessingContext.availableSamplers[h]=p,this._addSamplerBindingDescription(h,p,!t);for(let e=0;e<n;++e)this._addTextureBindingDescription(a,o,e,y,null,!t)}else this._addUniformToLeftOverUBO(a,s,r),e=""}return e}uniformBufferProcessor(e,t){const r=/uniform\s+(\w+)/gm.exec(e);if(null!==r){const s=r[1];let i=this._webgpuProcessingContext.availableBuffers[s];if(!i){const e=n.E.KnownUBOs[s];let t;t=e&&-1!==e.binding.groupIndex?e.binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),i={binding:t},this._webgpuProcessingContext.availableBuffers[s]=i}this._addBufferBindingDescription(s,i,"uniform",!t),e=e.replace("uniform",`layout(set = ${i.binding.groupIndex}, binding = ${i.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,r,n,s){const i=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),r){const t=e.indexOf("gl_FragCoord")>=0,r="\n                glFragCoord_ = gl_FragCoord;\n                if (yFactor_ == 1.) {\n                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;\n                }\n            ",n=t?"vec4 glFragCoord_;\n":"",s=-1!==e.search(/layout *\(location *= *0\) *out/g);if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){const t=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==t&&(e=e.substring(0,t.index)+"layout(location = 0) "+e.substring(t.index))}else e=e.replace(/void\s+?main\s*\(/g,(i||s?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",n),t&&(e=(0,a.bI)(e,"void main",r))}else if(e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex"),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;if(!r){const t=e.lastIndexOf("}");e=e.substring(0,t),e+="gl_Position.y *= yFactor_;\n",e+="}"}return e}_applyTextureArrayProcessing(e,t){const r=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let n=r.exec(e);for(;null!==n;){const s=n[1];let i=+s;this._preProcessors&&isNaN(i)&&(i=+this._preProcessors[s.trim()]),e=e.replace(n[0],t+i),n=r.exec(e)}return e}_generateLeftOverUBOCode(e,t){let r=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {\n    `;for(const e of this._webgpuProcessingContext.leftOverUniforms)e.length>0?r+=`    ${e.type} ${e.name}[${e.length}];\n`:r+=`    ${e.type} ${e.name};\n`;return r+="};\n\n",r}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){const n=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,n),t=this._applyTextureArrayProcessing(t,n)}for(let e=0;e<this._missingVaryings.length;++e){const r=this._missingVaryings[e];r&&r.length>0&&(t=r+"\n"+t)}const r=this._buildLeftOverUBO();return e=r+e,t=r+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}},4264:(e,t,r)=>{r.d(t,{z:()=>u});var n=r(7436),s=r(461),i=r(9594),a=r(2118);r(2600),r(2910),r(483),r(9929),r(8458),r(1812),r(270),r(3752),r(6734),r(887);const o={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null};class u extends i.q{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0,this.pureMode=!1}preProcessor(e,t,r,n,s){for(const t in r){if("__VERSION__"===t)continue;const n=r[t];isNaN(parseInt(n))&&isNaN(parseFloat(n))||(e=`const ${t} = ${n};\n`+e)}return e}_getArraySize(e,t,r){let n=0;const s=t.lastIndexOf(">");if(t.indexOf("array")>=0&&s>0){let e=s;for(;e>0&&" "!==t.charAt(e)&&","!==t.charAt(e);)e--;const i=t.substring(e+1,s);for(n=+i,isNaN(n)&&(n=+r[i.trim()]);e>0&&(" "===t.charAt(e)||","===t.charAt(e));)e--;t=t.substring(t.indexOf("<")+1,e+1)}return[e,t,n]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){const t=this.pureMode?"":`struct ${i.q.InternalsUBOName} {\n  yFactor_: f32,\n  textureOutputHeight_: f32,\n};\nvar<uniform> internals : ${i.q.InternalsUBOName};\n`;return-1!==e.indexOf(t)?e:t+(0,a.RJ)(e)}varyingCheck(e){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,r){const n=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==n){const i=n[1]??"perspective",a=n[2]??"center",o=n[4],u=n[3],c="flat"===i?`@interpolate(${i})`:`@interpolate(${i}, ${a})`;let l;t?(l=this._webgpuProcessingContext.availableVaryings[u],void 0===l&&s.V.Warn(`Invalid fragment shader: The varying named "${u}" is not declared in the vertex shader! This declaration will be ignored.`)):(l=this._webgpuProcessingContext.getVaryingNextLocation(o,this._getArraySize(u,o,r)[2]),this._webgpuProcessingContext.availableVaryings[u]=l,this._varyingsWGSL.push(`  @location(${l}) ${c} ${u} : ${o},`),this._varyingNamesWGSL.push(u)),e=""}return e}attributeProcessor(e,t){const r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==r){const n=r[2],s=r[1],i=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(s,n,t)[2]);this._webgpuProcessingContext.availableAttributes[s]=i,this._webgpuProcessingContext.orderedAttributes[i]=s;const a=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[s];if(void 0!==a){const e=a<0?-1===a?"i32":"vec"+-a+"<i32>":1===a?"u32":"vec"+a+"<u32>",t=`_int_${s}_`;this._attributesInputWGSL.push(`@location(${i}) ${t} : ${e},`),this._attributesWGSL.push(`${s} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${s} = ${n}(vertexInputs_.${t});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${i}) ${s} : ${n},`),this._attributesWGSL.push(`${s} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${s} = vertexInputs_.${s};`);e=""}return e}uniformProcessor(e,t,r){const n=this.uniformRegexp.exec(e);if(null!==n){const t=n[2],s=n[1];this._addUniformToLeftOverUBO(s,t,r),e=""}return e}textureProcessor(e,t,r){const n=this.textureRegexp.exec(e);if(null!==n){const s=n[1],i=n[2],a=!!n[3],u=n[4],c=u.indexOf("storage")>0,l=n[6],h=c?l.substring(0,l.indexOf(",")).trim():null;let p=a?this._getArraySize(s,i,r)[2]:0,d=this._webgpuProcessingContext.availableTextures[s];if(d)p=d.textures.length;else{d={isTextureArray:p>0,isStorageTexture:c,textures:[],sampleType:"float"},p=p||1;for(let e=0;e<p;++e)d.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[s]=d;const g=u.indexOf("depth")>0,m=o[u],f=g?"depth":"u32"===l?"uint":"i32"===l?"sint":"float";if(d.sampleType=f,void 0===m)throw`Can't get the texture dimension corresponding to the texture function "${u}"!`;for(let r=0;r<p;++r){const{groupIndex:n,bindingIndex:i}=d.textures[r];0===r&&(e=`@group(${n}) @binding(${i}) ${e}`),this._addTextureBindingDescription(s,d,r,m,h,!t)}}return e}postProcessor(e){const t=/#define (.+?) (.+?)$/gm;let r;for(;null!==(r=t.exec(e));)e=e.replace(new RegExp(r[1],"g"),r[2]);return e}finalizeShaders(e,t){const r=t.indexOf("fragmentInputs.position")>=0&&!this.pureMode?"\n            if (internals.yFactor_ == 1.) {\n                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;\n            }\n        ":"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const n=this._buildLeftOverUBO();t=n+t,e=(e=(e=n+e).replace(/#define (\w+)\s+(\d+\.?\d*)/g,"const $1 = $2;")).replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let s="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesInputWGSL.length>0&&(s+=this._attributesInputWGSL.join("\n")),s+="\n};\nvar<private> vertexInputs"+(this._hasNonFloatAttribute?"_":"")+" : VertexInputs;\n",this._hasNonFloatAttribute&&(s+="struct VertexInputs_ {\n  vertexIndex : u32, instanceIndex : u32,\n",s+=this._attributesWGSL.join("\n"),s+="\n};\nvar<private> vertexInputs : VertexInputs_;\n");let i="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(i+=this._varyingsWGSL.join("\n")),i+="\n};\nvar<private> vertexOutputs : FragmentInputs;\n",e=s+i+e;let o=`\n  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;\n`;this._hasNonFloatAttribute&&(o+="vertexInputs.vertexIndex = vertexInputs_.vertexIndex;\nvertexInputs.instanceIndex = vertexInputs_.instanceIndex;\n",o+=this._attributesConversionCodeWGSL.join("\n"),o+="\n");const u=this.pureMode?"  return vertexOutputs;":"  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;\n  return vertexOutputs;";let c=-1!==e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS");e=(c?"diagnostic(off, derivative_uniformity);\n":"")+(0,a.bI)(e,"fn main",o,u),t=(t=t.replace(/#define (\w+)\s+(\d+\.?\d*)/g,"const $1 = $2;")).replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),this.pureMode||(t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let l="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(l+=this._varyingsWGSL.join("\n")),l+="\n};\nvar<private> fragmentInputs : FragmentInputs;\n";let h="struct FragmentOutputs {\n",p=/const SCENE_MRT_COUNT = (\d+);/,d=t.match(p),g=0;if(d){const e=parseInt(d[1]);if(e>0){for(let t=0;t<e;t++)h+=` @location(${g}) fragData${g} : vec4<f32>,\n`,g++;-1!==t.indexOf("MRT_AND_COLOR")&&(h+=`  @location(${g}) color : vec4<f32>,\n`,g++)}}p=/oitDepthSampler/,d=t.match(p),d&&(h+=` @location(${g++}) depth : vec2<f32>,\n`,h+=` @location(${g++}) frontColor : vec4<f32>,\n`,h+=` @location(${g++}) backColor : vec4<f32>,\n`),0===g&&(h+="  @location(0) color : vec4<f32>,\n",g++);let m=!1,f=0;for(;!(m||(f=t.indexOf("fragmentOutputs.fragDepth",f),f<0));){const e=f;for(m=!0;f>1&&"\n"!==t.charAt(f);){if("/"===t.charAt(f)&&"/"===t.charAt(f-1)){m=!1;break}f--}f=e+25}m&&(h+="  @builtin(frag_depth) fragDepth: f32,\n"),h+="};\nvar<private> fragmentOutputs : FragmentOutputs;\n";const _="  fragmentInputs = input;\n  "+r;return c=-1!==(t=l+h+t).indexOf("#define DISABLE_UNIFORMITY_ANALYSIS"),t=(c?"diagnostic(off, derivative_uniformity);\n":"")+(0,a.bI)(t,"fn main",_,"  return fragmentOutputs;"),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let r="",n=`struct ${e} {\n`;for(const t of this._webgpuProcessingContext.leftOverUniforms){const s=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),a=i.q.UniformSizes[s];if(t.length>0)if(a<=2){const i=`${e}_${this._stridedUniformArrays.length}_strided_arr`;r+=`struct ${i} {\n                        @size(16)\n                        el: ${s},\n                    }`,this._stridedUniformArrays.push(t.name),n+=` @align(16) ${t.name} : array<${i}, ${t.length}>,\n`}else n+=` ${t.name} : array<${t.type}, ${t.length}>,\n`;else n+=`  ${t.name} : ${t.type},\n`}return n+="};\n",n=`${r}\n${n}`,n+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};\n`,n}_processSamplers(e,t){const r=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const n=r.exec(e);if(null===n)break;const s=n[1],i=n[2],a=s.length-7,o=s.lastIndexOf("Sampler")===a?s.substring(0,a):null,u="sampler_comparison"===i?"comparison":"filtering";if(o){const e=this._webgpuProcessingContext.availableTextures[o];e&&(e.autoBindSampler=!0)}let c=this._webgpuProcessingContext.availableSamplers[s];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:u},this._webgpuProcessingContext.availableSamplers[s]=c),this._addSamplerBindingDescription(s,c,t);const l=e.substring(0,n.index),h=`@group(${c.binding.groupIndex}) @binding(${c.binding.bindingIndex}) `,p=e.substring(n.index);e=l+h+p,r.lastIndex+=h.length}return e}_processCustomBuffers(e,t){const r=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const s=r.exec(e);if(null===s)break;const i=s[1],a=s[3];let o=s[4];const u=s[5];let c=this._webgpuProcessingContext.availableBuffers[o];if(!c){const e="uniform"===i?n.E.KnownUBOs[u]:null;let t;e?(o=u,t=e.binding,-1===t.groupIndex&&(t=this._webgpuProcessingContext.availableBuffers[o]?.binding,t||(t=this._webgpuProcessingContext.getNextFreeUBOBinding()))):t=this._webgpuProcessingContext.getNextFreeUBOBinding(),c={binding:t},this._webgpuProcessingContext.availableBuffers[o]=c}this._addBufferBindingDescription(o,this._webgpuProcessingContext.availableBuffers[o],"read_write"===a?"storage":"storage"===i?"read-only-storage":"uniform",t);const l=c.binding.groupIndex,h=c.binding.bindingIndex,p=e.substring(0,s.index),d=`@group(${l}) @binding(${h}) `,g=e.substring(s.index);e=p+d+g,r.lastIndex+=d.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}},7397:(e,t,r)=>{r.d(t,{V:()=>n});class n{constructor(e,t,r){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=r}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t;if(this._record)t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset();else{if(this._playBundleListIndex>=this._allBundleLists.length)throw new Error(`Invalid playBundleListIndex! Your snapshot is no longer valid for the current frame, you should recreate a new one. playBundleListIndex=${this._playBundleListIndex}, allBundleLists.length=${this._allBundleLists.length}}`);t=this._allBundleLists[this._playBundleListIndex++]}return t.run(e),1===this._mode&&this._engine._reportDrawCall(t.numDrawCalls),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved),this._playBundleListIndex=0}reset(){this.enabled=!1,this.enabled=!0}}},9194:(e,t,r)=>{r.d(t,{K:()=>s});var n=r(4096);class s extends n.u{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){const e=this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask)}}},9738:(e,t,r)=>{r.d(t,{m:()=>s});var n=r(7020);class s{static ComputeNumMipmapLevels(e,t){return n.X.ILog2(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"rgb9e5ufloat":case"rg11b10ufloat":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":case"stencil8":return 0;case"r16uint":case"r16sint":case"rg16uint":case"rg16sint":case"rgba16uint":case"rgba16sint":case"depth16unorm":return 5;case"r16float":case"rg16float":case"rgba16float":return 2;case"r32uint":case"r32sint":case"rg32uint":case"rg32sint":case"rgba32uint":case"rgba32sint":return 7;case"r32float":case"rg32float":case"rgba32float":case"depth32float":case"depth32float-stencil8":case"depth24plus":case"depth24plus-stencil8":return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth16unorm":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2uint":case"rgb10a2unorm":case"rg11b10ufloat":case"depth32float":return{width:1,height:1,length:4};case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":return{width:4,height:4,length:8};case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":return{width:5,height:4,length:16};case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":return{width:5,height:5,length:16};case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":return{width:6,height:5,length:16};case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":return{width:6,height:6,length:16};case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":return{width:8,height:5,length:16};case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":return{width:8,height:6,length:16};case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":return{width:8,height:8,length:16};case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":return{width:10,height:5,length:16};case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":return{width:10,height:6,length:16};case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":return{width:10,height:8,length:16};case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":return{width:10,height:10,length:16};case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":return{width:12,height:10,length:16};case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}static IsCompressedFormat(e){switch(e){case"bc7-rgba-unorm-srgb":case"bc7-rgba-unorm":case"bc6h-rgb-float":case"bc6h-rgb-ufloat":case"bc5-rg-snorm":case"bc5-rg-unorm":case"bc4-r-snorm":case"bc4-r-unorm":case"bc3-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc1-rgba-unorm-srgb":case"bc1-rgba-unorm":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return!0}return!1}static GetWebGPUTextureFormat(e,t,r=!1){switch(t){case 15:return"depth16unorm";case 16:return"depth24plus";case 13:return"depth24plus-stencil8";case 14:return"depth32float";case 18:return"depth32float-stencil8";case 19:return"stencil8";case 36492:return r?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case 36495:return"bc6h-rgb-ufloat";case 36494:return"bc6h-rgb-float";case 33779:return r?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case 33778:return r?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case 33777:case 33776:return r?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case 37808:return r?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case 36196:case 37492:return r?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case 37496:return r?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case 3:switch(t){case 6:return"r8snorm";case 7:return"rg8snorm";case 4:throw"RGB format not supported in WebGPU";case 8:return"r8sint";case 9:return"rg8sint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8sint";default:return"rgba8snorm"}case 0:switch(t){case 6:return"r8unorm";case 7:return"rg8unorm";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return r?"rgba8unorm-srgb":"rgba8unorm";case 12:return r?"bgra8unorm-srgb":"bgra8unorm";case 8:return"r8uint";case 9:return"rg8uint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8uint";case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return"rgba8unorm"}case 4:switch(t){case 8:return"r16sint";case 9:return"rg16sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba16sint"}case 5:switch(t){case 8:return"r16uint";case 9:return"rg16uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba16uint"}case 6:switch(t){case 8:return"r32sint";case 9:return"rg32sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba32sint"}case 7:switch(t){case 8:return"r32uint";case 9:return"rg32uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba32uint"}case 1:switch(t){case 6:return"r32float";case 7:return"rg32float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return"rgba32float"}case 2:switch(t){case 6:return"r16float";case 7:return"rg16float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return"rgba16float"}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:default:return"rg11b10ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV"}case 14:switch(t){case 5:default:return"rgb9e5ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:default:return"rgb10a2unorm";case 11:return"rgb10a2uint"}}return r?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"bc4-r-unorm":case"bc4-r-snorm":case"r16uint":case"r16sint":case"depth16unorm":case"r16float":case"r32uint":case"r32sint":case"r32float":case"depth32float":case"stencil8":case"depth24plus":case"eac-r11unorm":case"eac-r11snorm":return 1;case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth32float-stencil8":case"bc5-rg-unorm":case"bc5-rg-snorm":case"rg16uint":case"rg16sint":case"rg16float":case"rg32uint":case"rg32sint":case"rg32float":case"depth24plus-stencil8":case"eac-rg11unorm":case"eac-rg11snorm":return 2;case"rgb9e5ufloat":case"rg11b10ufloat":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":return 3;case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba32uint":case"rgba32sint":case"rgba32float":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case"stencil8":case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static GetDepthFormatOnly(e){switch(e){case"depth16unorm":return"depth16unorm";case"depth24plus":case"depth24plus-stencil8":return"depth24plus";case"depth32float":case"depth32float-stencil8":return"depth32float"}return e}static GetSample(e){return e>1?4:1}}},2079:(e,t,r)=>{r.d(t,{g:()=>p,n:()=>d});var n=r(2455),s=r(974),i=r(9738),a=r(3469);const o="\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));\n\n    var img: texture_2d<f32>;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        #ifdef INVERTY\n            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));\n        #endif\n        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",u=o;var c,l;!function(e){e[e.MipMap=0]="MipMap",e[e.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",e[e.Clear=2]="Clear",e[e.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"}(c||(c={})),function(e){e[e.DontInvertY=0]="DontInvertY",e[e.InvertY=1]="InvertY"}(l||(l={}));const h=[{vertex:"\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));\n\n    varying vTex: vec2f;\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        vertexOutputs.vTex = tex[input.vertexIndex];\n        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    var imgSampler: sampler;\n    var img: texture_2d<f32>;\n\n    varying vTex: vec2f;\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);\n    }\n    "},{vertex:o,fragment:"\n    var img: texture_2d<f32>;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n    #ifdef INVERTY\n        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);\n    #else\n        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        fragmentOutputs.color = vec4f(color.rgb * color.a, color.a);\n    #endif\n        fragmentOutputs.color = color;\n    }\n    "},{vertex:"\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    uniform color: vec4f;\n\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        fragmentOutputs.color = uniforms.color;\n    }\n    "},{vertex:u,fragment:"\n    var img: texture_2d<f32>;\n    uniform ofstX: f32;\n    uniform ofstY: f32;\n    uniform width: f32;\n    uniform height: f32;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {\n            discard;\n        }\n        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {\n            discard;\n        }\n    #ifdef INVERTY\n        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);\n    #else\n        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color = vec4f(color.rgb * color.a, color.a);\n    #endif\n        fragmentOutputs.color = color;\n    }\n    "}],p={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38};class d{constructor(e,t,r,s){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=r,-1!==s.indexOf("rg11b10ufloat-renderable")){const e=Object.keys(p);p.rg11b10ufloat=p[e[e.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,n.Sd.Uniform|n.Sd.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm")}_getPipeline(e,t=c.MipMap,r){const n=t===c.MipMap?1:t===c.InvertYPremultiplyAlpha?((r.invertY?1:0)<<1)+((r.premultiplyAlpha?1:0)<<2):t===c.Clear?8:t===c.InvertYPremultiplyAlphaWithOfst?((r.invertY?1:0)<<4)+((r.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let s=this._pipelines[e][n];if(!s){let i="";t!==c.InvertYPremultiplyAlpha&&t!==c.InvertYPremultiplyAlphaWithOfst||(r.invertY&&(i+="#define INVERTY\n"),r.premultiplyAlpha&&(i+="#define PREMULTIPLYALPHA\n"));let o=this._compiledShaders[n];if(!o){let e=h[t].vertex,r=h[t].fragment;const s={defines:i.split("\n"),indexParameters:null,isFragment:!1,shouldUseHighPrecisionShader:!0,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:!0,shadersRepository:"",includesShadersStore:{},version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,!0),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};(0,a.pB)(s),s.processor.pureMode=!0,(0,a.M0)(e,s,(t=>{e=t}),this._engine),s.isFragment=!0,(0,a.M0)(r,s,(e=>{r=e}),this._engine);const u=(0,a.nO)(e,r,s);s.processor.pureMode=!1;const c=this._device.createShaderModule({code:u.vertexCode}),l=this._device.createShaderModule({code:u.fragmentCode});o=this._compiledShaders[n]=[c,l]}const u=this._device.createRenderPipeline({layout:"auto",vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});s=this._pipelines[e][n]=[u,u.getBindGroupLayout(0)]}return s}_getVideoPipeline(e,t=l.DontInvertY){const r=t===l.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let n=this._videoPipelines[e][r];if(!n){let t=this._videoCompiledShaders[r];if(!t){const e=this._device.createShaderModule({code:"\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n\n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    "}),n=this._device.createShaderModule({code:0===r?"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    ":"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    "});t=this._videoCompiledShaders[r]=[e,n]}const s=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_${e}_${0===r?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:t[0],entryPoint:"main"},fragment:{module:t[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});n=this._videoPipelines[e][r]=[s,s.getBindGroupLayout(0)]}return n}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,r,n=!1,s){const i=void 0===s,[a,o]=this._getVideoPipeline(r,n?l.InvertY:l.DontInvertY);i&&(s=this._device.createCommandEncoder({})),s.pushDebugGroup?.(`copy video to texture - invertY=${n}`);const u=t._hardwareTexture,c={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${r}_${n?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:u.underlyingResource.createView({format:r,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},h=s.beginRenderPass(c),p={layout:o,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},d=this._device.createBindGroup(p);h.setPipeline(a),h.setBindGroup(0,d),h.draw(4,1,0,0),h.end(),s.popDebugGroup?.(),i&&(this._device.queue.submit([s.finish()]),s=null)}invertYPreMultiplyAlpha(e,t,r,n,s=!1,a=!1,o=0,u=0,l=1,h=0,p=0,d=0,g=0,m,f){const _=0!==d,b=void 0===m,[x,y]=this._getPipeline(n,_?c.InvertYPremultiplyAlphaWithOfst:c.InvertYPremultiplyAlpha,{invertY:s,premultiplyAlpha:a});let S;if(o=Math.max(o,0),b&&(m=this._device.createCommandEncoder({})),m.pushDebugGroup?.(`internal process texture - invertY=${s} premultiplyAlpha=${a}`),i.m.IsHardwareTexture(e)?(S=e.underlyingResource,s&&!a&&1===l&&0===o||(e=void 0)):(S=e,e=void 0),!S)return;_&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([h,p,d,g]),0,16);const v=e,I=v?._copyInvertYTempTexture??this.createTexture({width:t,height:r,layers:1},!1,!1,!1,!1,!1,n,1,m,21,void 0,"TempTextureForCopyWithInvertY"),B=v?._copyInvertYRenderPassDescr??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${n}_${s?"InvertY":"DontInvertY"}_${a?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:I.createView({format:n,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},w=m.beginRenderPass(B);let T=_?v?._copyInvertYBindGroupWithOfst:v?._copyInvertYBindGroup;if(!T){const e={layout:y,entries:[{binding:0,resource:S.createView({format:n,dimension:"2d",baseMipLevel:u,mipLevelCount:1,arrayLayerCount:l,baseArrayLayer:o})}]};_&&e.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),T=this._device.createBindGroup(e)}w.setPipeline(x),w.setBindGroup(0,T),w.draw(4,1,0,0),w.end(),m.copyTextureToTexture({texture:I},{texture:S,mipLevel:u,origin:{x:0,y:0,z:o}},{width:t,height:r,depthOrArrayLayers:1}),v?(v._copyInvertYTempTexture=I,v._copyInvertYRenderPassDescr=B,_?v._copyInvertYBindGroupWithOfst=T:v._copyInvertYBindGroup=T):this._deferredReleaseTextures.push([I,null]),m.popDebugGroup?.(),b&&(this._device.queue.submit([m.finish()]),m=null)}copyWithInvertY(e,t,r,n){const s=void 0===n,[i,a]=this._getPipeline(t,c.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});s&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup?.("internal copy texture with invertY");const o=n.beginRenderPass(r),u=this._device.createBindGroup({layout:a,entries:[{binding:0,resource:e}]});o.setPipeline(i),o.setBindGroup(0,u),o.draw(4,1,0,0),o.end(),n.popDebugGroup?.(),s&&(this._device.queue.submit([n.finish()]),n=null)}createTexture(e,t=!1,r=!1,n=!1,s=!1,a=!1,o="rgba8unorm",u=1,c,l=-1,h=0,d){u=i.m.GetSample(u);const g=e.layers||1,m={width:e.width,height:e.height,depthOrArrayLayers:g},f=p[o]?16:0,_=i.m.IsCompressedFormat(o),b=t?i.m.ComputeNumMipmapLevels(e.width,e.height):1,x=l>=0?l:7;h|=t&&!_?1|f:0,_||a||(h|=2|f);const y=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${a?"3D":"2D"}_${d?d+"_":""}${m.width}x${m.height}x${m.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${u}`,size:m,dimension:a?"3d":"2d",format:o,usage:x|h,sampleCount:u,mipLevelCount:b});return i.m.IsImageBitmap(e)&&(this.updateTexture(e,y,e.width,e.height,g,o,0,0,n,s,0,0),t&&r&&this.generateMipmaps(y,o,b,0,a,c)),y}createCubeTexture(e,t=!1,r=!1,n=!1,s=!1,a="rgba8unorm",o=1,u,c=-1,l=0,h){o=i.m.GetSample(o);const d=i.m.IsImageBitmapArray(e)?e[0].width:e.width,g=i.m.IsImageBitmapArray(e)?e[0].height:e.height,m=p[a]?16:0,f=i.m.IsCompressedFormat(a),_=t?i.m.ComputeNumMipmapLevels(d,g):1,b=c>=0?c:7;l|=t&&!f?1|m:0,f||(l|=2|m);const x=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${h?h+"_":""}${d}x${g}x6_${t?"wmips":"womips"}_${a}_samples${o}`,size:{width:d,height:g,depthOrArrayLayers:6},dimension:"2d",format:a,usage:b|l,sampleCount:o,mipLevelCount:_});return i.m.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,x,d,g,a,n,s,0,0),t&&r&&this.generateCubeMipmaps(x,a,_,u)),x}generateCubeMipmaps(e,t,r,n){const s=void 0===n;s&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup?.(`create cube mipmaps - ${r} levels`);for(let s=0;s<6;++s)this.generateMipmaps(e,t,r,s,!1,n);n.popDebugGroup?.(),s&&(this._device.queue.submit([n.finish()]),n=null)}generateMipmaps(e,t,r,n=0,s=!1,a){const o=void 0===a,[u,c]=this._getPipeline(t);let l;if(n=Math.max(n,0),o&&(a=this._device.createCommandEncoder({})),a.pushDebugGroup?.(`create mipmaps for face #${n} - ${r} levels`),i.m.IsHardwareTexture(e)?(l=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(l=e,e=void 0),!l)return;const h=e;for(let e=1;e<r;++e){const r=h?._mipmapGenRenderPassDescr[n]?.[e-1]??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${n}_level${e}`,colorAttachments:[{view:l.createView({format:t,dimension:s?"3d":"2d",baseMipLevel:e,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n}),loadOp:"load",storeOp:"store"}]};h&&(h._mipmapGenRenderPassDescr[n]=h._mipmapGenRenderPassDescr[n]||[],h._mipmapGenRenderPassDescr[n][e-1]=r);const i=a.beginRenderPass(r),o=h?._mipmapGenBindGroup[n]?.[e-1]??this._device.createBindGroup({layout:c,entries:[{binding:0,resource:l.createView({format:t,dimension:s?"3d":"2d",baseMipLevel:e-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n})},{binding:1,resource:this._mipmapSampler}]});h&&(h._mipmapGenBindGroup[n]=h._mipmapGenBindGroup[n]||[],h._mipmapGenBindGroup[n][e-1]=o),i.setPipeline(u),i.setBindGroup(0,o),i.draw(4,1,0,0),i.end()}a.popDebugGroup?.(),o&&(this._device.queue.submit([a.finish()]),a=null)}createGPUTextureForInternalTexture(e,t,r,n,a){e._hardwareTexture||(e._hardwareTexture=new s.Q),void 0===t&&(t=e.width),void 0===r&&(r=e.height),void 0===n&&(n=e.depth);const o=e._hardwareTexture,u=!!(1&(a??0));o.format=i.m.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),o.textureUsages=5===e._source||6===e.source?21:12===e._source?20:-1,o.textureAdditionalUsages=u?8:0;const c=e.generateMipMaps,l=n||1;let h;if(h=null!==e._maxLodLevel?e._maxLodLevel:c?i.m.ComputeNumMipmapLevels(t,r):1,e.isCube){const n=this.createCubeTexture({width:t,height:r},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(n);const s=e.is3D?1:l,a=i.m.GetDepthFormatOnly(o.format),p=i.m.HasDepthAndStencilAspects(o.format)?"depth-only":"all",d=e.is2DArray?"cube-array":"cube";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+s:""}_${t}x${r}_${c?"wmips":"womips"}_${a}_${d}_${p}_${e.label??"noname"}`,format:a,dimension:d,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:p},u)}else{const n=this.createTexture({width:t,height:r,layers:l},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(n);const s=e.is3D?1:l,a=i.m.GetDepthFormatOnly(o.format),p=i.m.HasDepthAndStencilAspects(o.format)?"depth-only":"all",d=e.is2DArray?"2d-array":e.is3D?"3d":"2d";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+s:""}_${t}x${r}${e.is3D?"x"+l:""}_${c?"wmips":"womips"}_${a}_${d}_${p}_${e.label??"noname"}`,format:a,dimension:d,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:s,aspect:p},u)}return e.width=e.baseWidth=t,e.height=e.baseHeight=r,e.depth=e.baseDepth=n,this.createMSAATexture(e,e.samples),o}createMSAATexture(e,t,r=!0,n=-1){const s=e._hardwareTexture;if(r&&s?.releaseMSAATexture(),!s||(t??1)<=1)return;const i=e.width,a=e.height,o=this.createTexture({width:i,height:a,layers:1},!1,!1,!1,!1,!1,s.format,t,this._commandEncoderForCreation,16,0,e.label?"MSAA"+e.label:void 0);s.setMSAATexture(o,n)}updateCubeTextures(e,t,r,n,s,i=!1,a=!1,o=0,u=0){const c=[0,3,1,4,2,5];for(let l=0;l<c.length;++l){const h=e[c[l]];this.updateTexture(h,t,r,n,1,s,l,0,i,a,o,u)}}updateTexture(e,t,r,s,a,o,u=0,c=0,l=!1,h=!1,p=0,d=0,g){const m=i.m.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,f=i.m.GetBlockInformationFromFormat(o),_=i.m.IsInternalTexture(t)?t._hardwareTexture:t,b={texture:m,origin:{x:p,y:d,z:Math.max(u,0)},mipLevel:c,premultipliedAlpha:h},x={width:Math.ceil(r/f.width)*f.width,height:Math.ceil(s/f.height)*f.height,depthOrArrayLayers:a||1};if(void 0!==e.byteLength){const y=Math.ceil(r/f.width)*f.length;if(256*Math.ceil(y/256)===y){const t=this._device.createCommandEncoder({}),r=this._bufferManager.createRawBuffer(e.byteLength,n.Sd.MapWrite|n.Sd.CopySrc,!0,"TempBufferForUpdateTexture"+(m?"_"+m.label:"")),i=r.getMappedRange();new Uint8Array(i).set(e),r.unmap(),t.copyBufferToTexture({buffer:r,offset:0,bytesPerRow:y,rowsPerImage:s},b,x),this._device.queue.submit([t.finish()]),this._bufferManager.releaseBuffer(r)}else this._device.queue.writeTexture(b,e,{offset:0,bytesPerRow:y,rowsPerImage:s},x);if(l||h){if(!i.m.IsInternalTexture(t))throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!";{const e=0===p&&0===d&&r===t.width&&s===t.height;this.invertYPreMultiplyAlpha(_,t.width,t.height,o,l,h,u,c,a||1,p,d,e?0:r,e?0:s,void 0,g)}}}else if(l)if(b.premultipliedAlpha=!1,i.m.IsInternalTexture(t)&&0===p&&0===d&&r===t.width&&s===t.height)this._device.queue.copyExternalImageToTexture({source:e},b,x),this.invertYPreMultiplyAlpha(_,r,s,o,l,h,u,c,a||1,0,0,0,0,void 0,g);else{const t=this._device.createCommandEncoder({}),n=this.createTexture({width:r,height:s,layers:1},!1,!1,!1,!1,!1,o,1,t,5,void 0,"TempTextureForUpdateTexture");this._deferredReleaseTextures.push([n,null]),x.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:n},x),x.depthOrArrayLayers=a||1,this.invertYPreMultiplyAlpha(n,r,s,o,l,h,u,c,a||1,0,0,0,0,t,g),t.copyTextureToTexture({texture:n},b,x),this._device.queue.submit([t.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},b,x)}readPixels(e,t,r,s,a,o,u=0,c=0,l=null,h=!1){const p=i.m.GetBlockInformationFromFormat(o),d=Math.ceil(s/p.width)*p.length,g=256*Math.ceil(d/256),m=g*a,f=this._bufferManager.createRawBuffer(m,n.Sd.MapRead|n.Sd.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),_=this._device.createCommandEncoder({});return _.copyTextureToBuffer({texture:e,mipLevel:c,origin:{x:t,y:r,z:Math.max(u,0)}},{buffer:f,offset:0,bytesPerRow:g},{width:s,height:a,depthOrArrayLayers:1}),this._device.queue.submit([_.finish()]),this._bufferManager.readDataFromBuffer(f,m,s,a,d,g,i.m.GetTextureTypeFromFormat(o),0,l,!0,h)}releaseTexture(e){if(i.m.IsInternalTexture(e)){const t=e._hardwareTexture,r=e._irradianceTexture;this._deferredReleaseTextures.push([t,r])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,r]=this._deferredReleaseTextures[e];t&&(i.m.IsHardwareTexture(t)?t.release():t.destroy()),r?.dispose()}this._deferredReleaseTextures.length=0}}},5501:(e,t,r)=>{r.d(t,{e:()=>a});var n=r(9724),s=r(8173),i=r(461);class a{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,r){this._enabled=!1,this._gpuFrameTimeCounter=new n.A,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=r}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new o(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(e){return this._enabled=!1,void i.V.Error("Could not create a WebGPUDurationMeasure!\nError: "+e.message+"\nMake sure timestamp query is supported and enabled in your browser.")}else this._measureDuration.dispose()}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then((e=>{null!==e&&e>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(e,!0)),this._measureDurationState=0})))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;const r=this._engine.frameId;this._measureDuration.stopPass(e).then((e=>{t._addDuration(r,null!==e&&e>0?e:0)}))}dispose(){this._measureDuration?.dispose()}}class o{constructor(e,t,r,n=2,i){this._count=n,this._querySet=new s.L(e,n,"timestamp",t,r,!0,i)}start(e){e.writeTimestamp?.(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp?.(this._querySet.querySet,1),e.writeTimestamp?this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw new Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}async stopPass(e){return this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose()}}},2796:(e,t,r)=>{r.d(t,{g:()=>i});var n=r(461),s=r(66);class i{async initTwgsl(e){if(!i._Twgsl)return e=e||{},(e={...i._TWgslDefaultOptions,...e}).twgsl?(i._Twgsl=e.twgsl,Promise.resolve()):(e.jsPath&&e.wasmPath&&await s.S0.LoadBabylonScriptAsync(e.jsPath),self.twgsl?(i._Twgsl=await self.twgsl(s.S0.GetBabylonScriptURL(e.wasmPath)),Promise.resolve()):Promise.reject("twgsl is not available."))}convertSpirV2WGSL(e,t=!1){const r=i._Twgsl.convertSpirV2WGSL(e,i.DisableUniformityAnalysis||t);return i.ShowWGSLShaderCode&&(n.V.Log(r),n.V.Log("***********************************************")),i.DisableUniformityAnalysis||t?"diagnostic(off, derivative_uniformity);\n"+r:r}}i._TWgslDefaultOptions={jsPath:`${s.S0._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${s.S0._DefaultCdnUrl}/twgsl/twgsl.wasm`},i.ShowWGSLShaderCode=!1,i.DisableUniformityAnalysis=!1,i._Twgsl=null}}]);
//# sourceMappingURL=webgpu-extensions.js.map